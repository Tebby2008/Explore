<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>LingoBot</title>
Â  Â  <link rel="icon" type="image/png" href="https://icons.veryicon.com/png/o/weather/weather-5/stars-4.png">
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
Â  Â  <script>
Â  Â  Â  Â  tailwind.config = {
Â  Â  Â  Â  Â  Â  theme: {
Â  Â  Â  Â  Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'bg-deep': '#020617',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'accent-purple': '#8B5CF6',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'glass-surface': 'rgba(30, 41, 59, 0.2)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'glass-input': 'rgba(17, 24, 39, 0.7)',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'glass-ai': 'rgba(30, 41, 59, 0.6)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'text-light': '#F3F4F6',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fontFamily: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sans: ['Inter', 'sans-serif'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  boxShadow: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'liquid': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'glow-lg': '0 10px 40px rgba(139, 92, 246, 0.4), 0 4px 6px rgba(0, 0, 0, 0.1)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
Â  Â  Â  Â Â 
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  background-color: #020617;Â 
Â  Â  Â  Â  Â  Â  background-image: radial-gradient(circle at 10% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 90% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%);
Â  Â  Â  Â  Â  Â  transition: all 0.5s ease-in-out;
Â  Â  Â  Â  }

Â  Â  Â  Â  .glassy-element {
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(30px) saturate(180%);
Â  Â  Â  Â  Â  Â  -webkit-backdrop-filter: blur(30px) saturate(180%);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.15);
Â  Â  Â  Â  Â  Â  transition: all 0.5s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .welcome-state {
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .chat-state {
Â  Â  Â  Â  Â  Â  justify-content: flex-start;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .chat-scroll::-webkit-scrollbar { width: 8px; }
Â  Â  Â  Â  .chat-scroll::-webkit-scrollbar-thumb {
Â  Â  Â  Â  Â  Â  background-color: #8B5CF699;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-scroll::-webkit-scrollbar-track { background-color: transparent; }

Â  Â  Â  Â  .dot {
Â  Â  Â  Â  Â  Â  width: 8px;
Â  Â  Â  Â  Â  Â  height: 8px;
Â  Â  Â  Â  Â  Â  margin: 0 4px;
Â  Â  Â  Â  Â  Â  background-color: #8B5CF6;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  animation: bounce 1.4s infinite ease-in-out both;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dot-1 { animation-delay: -0.32s; }
Â  Â  Â  Â  .dot-2 { animation-delay: -0.16s; }
Â  Â  Â  Â  .dot-3 { animation-delay: 0s; }

Â  Â  Â  Â  @keyframes bounce {
Â  Â  Â  Â  Â  Â  0%, 80%, 100% { transform: scale(0); }
Â  Â  Â  Â  Â  Â  40% { transform: scale(1.0); }
Â  Â  Â  Â  }

Â  Â  Â  Â  .word-fade-in {
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transition: opacity 0.2s ease-in;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* New class for the header gradient */
Â  Â  Â  Â  .header-gradient-bg {
Â  Â  Â  Â  Â  Â  background: linear-gradient(180deg, rgba(2, 6, 23, 1) 40%, rgba(2, 6, 23, 0.7) 70%, rgba(2, 6, 23, 0) 100%);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Styles for rendered Markdown elements within the chat bubble */
Â  Â  Â  Â  .ai-message-content p {
Â  Â  Â  Â  Â  Â  margin-bottom: 0.5rem; /* Space between paragraphs if applicable */
Â  Â  Â  Â  }

Â  Â  Â  Â  .ai-message-content code {
Â  Â  Â  Â  Â  Â  /* Basic styling for inline code or math to make it stand out */
Â  Â  Â  Â  Â  Â  background-color: rgba(139, 92, 246, 0.2); /* Light purple background */
Â  Â  Â  Â  Â  Â  padding: 0.1rem 0.3rem;
Â  Â  Â  Â  Â  Â  border-radius: 0.25rem;
Â  Â  Â  Â  Â  Â  font-family: monospace;
Â  Â  Â  Â  Â  Â  font-size: 0.95em;
Â  Â  Â  Â  }

Â  Â  </style>
</head>
<body class="font-sans min-h-screen flex flex-col items-center justify-between">

Â  Â  <div id="main-container" class="w-full h-full max-w-4xl flex flex-col min-h-screen chat-state">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="header-input-wrapper" class="w-full transition-all duration-500 ease-in-out">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <header id="app-header" class="w-full transition-all duration-500 ease-in-out">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="header-content" class="px-4 text-center py-20 md:py-25 w-full max-w-6xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-wider">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  LingoBot
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="app-description" class="text-text-light text-opacity-80 mt-2 text-lg font-light transition-opacity duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Your Gen Alpha Rizzler. Let's cook.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </header>

Â  Â  Â  Â  Â  Â  <div id="input-bar-container" class="w-full flex justify-center pb-8 md:pb-12 transition-all duration-500 ease-in-out">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full max-w-3xl px-4">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex items-center space-x-3 glassy-element rounded-[3rem] shadow-glow-lg p-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textareaÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id="message-input"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="chat with the rizzler..."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rows="1"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex-grow p-2 pl-6 bg-transparent text-text-light placeholder-gray-400 focus:outline-none resize-none overflow-hidden text-base"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  oninput="resizeTextarea()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); document.getElementById('send-button').click(); }"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id="send-button"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="handleChat()"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-accent-purple text-white p-3 rounded-full hover:bg-opacity-90 active:scale-95 transition duration-150 transform shadow-md focus:outline-none focus:ring-4 focus:ring-accent-purple/50 disabled:opacity-50"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  disabled
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="chat-history" class="w-full flex-grow overflow-y-auto chat-scroll flex flex-col pb-28 hidden transition-opacity duration-300">
Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const WORKER_URL = 'https://lingo-chatbot.tebby2008-li.workers.dev/chat';
Â  Â  Â  Â  const MAX_RETRIES = 3;
Â  Â  Â  Â  const BASE_DELAY_MS = 1000;
Â  Â  Â  Â  const TYPING_SPEED_MS = 20;
Â  Â  Â  Â  const MAX_MESSAGE_LENGTH = 1000;Â 

Â  Â  Â  Â  let sessionId;
Â  Â  Â  Â  let isChatActive = false;Â 

Â  Â  Â  Â  const mainContainer = document.getElementById('main-container');
Â  Â  Â  Â  const chatHistory = document.getElementById('chat-history');
Â  Â  Â  Â  const messageInput = document.getElementById('message-input');
Â  Â  Â  Â  const sendButton = document.getElementById('send-button');
Â  Â  Â  Â  const header = document.getElementById('app-header');
Â  Â  Â  Â  const headerContent = document.getElementById('header-content');
Â  Â  Â  Â  const inputContainer = document.getElementById('input-bar-container');

Â  Â  Â  Â  // Setup marked.js to allow only safe, basic elements
Â  Â  Â  Â  // This creates an instance of marked with specific options
Â  Â  Â  Â  const customMarked = new marked.Marked({
Â  Â  Â  Â  Â  Â  mangle: false,
Â  Â  Â  Â  Â  Â  headerIds: false,
Â  Â  Â  Â  Â  Â  silent: true, // Prevents throwing errors for unhandled markdown
Â  Â  Â  Â  Â  Â  // Basic renderer to specifically target the elements we want to style
Â  Â  Â  Â  Â  Â  renderer: {
Â  Â  Â  Â  Â  Â  Â  Â  // Only allow these common, safe inline/block elements
Â  Â  Â  Â  Â  Â  Â  Â  paragraph: (text) => `<p>${text}</p>`,
Â  Â  Â  Â  Â  Â  Â  Â  strong: (text) => `<strong>${text}</strong>`,
Â  Â  Â  Â  Â  Â  Â  Â  em: (text) => `<em>${text}</em>`,
Â  Â  Â  Â  Â  Â  Â  Â  codespan: (text) => `<code>${text}</code>`, // Used for inline math/code
Â  Â  Â  Â  Â  Â  Â  Â  // Block code can be simple pre-formatted text
Â  Â  Â  Â  Â  Â  Â  Â  code: (code) => `<pre><code>${code}</code></pre>`,
Â  Â  Â  Â  Â  Â  Â  Â  // Reject everything else to keep it simple and safe
Â  Â  Â  Â  Â  Â  Â  Â  link: (href, title, text) => text, // Render links as just text
Â  Â  Â  Â  Â  Â  Â  Â  image: () => '',
Â  Â  Â  Â  Â  Â  Â  Â  table: () => '',
Â  Â  Â  Â  Â  Â  Â  Â  html: () => '',
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  // Marked's parser returns a promise, so we use .then or await it
Â  Â  Â  Â  const parseMarkdown = (markdown) => customMarked.parse(markdown);


Â  Â  Â  Â  function updateUIState(hasMessages) {
Â  Â  Â  Â  Â  Â  if (hasMessages === isChatActive) return;

Â  Â  Â  Â  Â  Â  isChatActive = hasMessages;

Â  Â  Â  Â  Â  Â  if (hasMessages) {
Â  Â  Â  Â  Â  Â  Â  Â  mainContainer.classList.remove('welcome-state');
Â  Â  Â  Â  Â  Â  Â  Â  mainContainer.classList.add('chat-state');

Â  Â  Â  Â  Â  Â  Â  Â  header.classList.add('fixed', 'top-0', 'left-0', 'right-0', 'z-20', 'header-gradient-bg'); // <-- ADDED GRADIENT
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  headerContent.classList.remove('py-20', 'md:py-25');
Â  Â  Â  Â  Â  Â  Â  Â  headerContent.classList.add('py-4', 'md:py-6');
Â  Â  Â  Â  Â  Â  Â  Â  headerContent.querySelector('h1').classList.remove('text-10xl', 'md:text-5xl');
Â  Â  Â  Â  Â  Â  Â  Â  headerContent.querySelector('h1').classList.add('text-3xl');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('app-description').style.display = 'none';

Â  Â  Â  Â  Â  Â  Â  Â  inputContainer.classList.remove('pb-8', 'md:pb-12');
Â  Â  Â  Â  Â  Â  Â  Â  inputContainer.classList.add('fixed', 'bottom-0', 'left-0', 'right-0', 'z-20', 'py-4', 'shadow-2xl');
Â  Â  Â  Â  Â  Â  Â  Â  inputContainer.querySelector('.w-full').classList.remove('max-w-3xl', 'px-4');
Â  Â  Â  Â  Â  Â  Â  Â  inputContainer.querySelector('.w-full').classList.add('max-w-3xl', 'lg:max-w-4xl', 'px-4', 'md:px-8');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  chatHistory.classList.add('opacity-0');Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  chatHistory.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  chatHistory.classList.add('flex', 'pt-20');

Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatHistory.classList.remove('opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  mainContainer.classList.remove('chat-state');
Â  Â  Â  Â  Â  Â  Â  Â  mainContainer.classList.add('welcome-state');

Â  Â  Â  Â  Â  Â  Â  Â  header.classList.remove('fixed', 'top-0', 'left-0', 'right-0', 'z-20', 'header-gradient-bg'); // <-- REMOVED GRADIENT

Â  Â  Â  Â  Â  Â  Â  Â  headerContent.classList.add('py-20', 'md:py-25');
Â  Â  Â  Â  Â  Â  Â  Â  headerContent.classList.remove('py-4', 'md:py-6');
Â  Â  Â  Â  Â  Â  Â  Â  headerContent.querySelector('h1').classList.add('text-4xl', 'md:text-5xl');
Â  Â  Â  Â  Â  Â  Â  Â  headerContent.querySelector('h1').classList.remove('text-3xl');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('app-description').style.display = 'block';

Â  Â  Â  Â  Â  Â  Â  Â  inputContainer.classList.add('pb-8', 'md:pb-12');
Â  Â  Â  Â  Â  Â  Â  Â  inputContainer.classList.remove('fixed', 'bottom-0', 'left-0', 'right-0', 'z-20', 'py-4', 'shadow-2xl');
Â  Â  Â  Â  Â  Â  Â  Â  inputContainer.querySelector('.w-full').classList.add('max-w-3xl', 'px-4');Â 
Â  Â  Â  Â  Â  Â  Â  Â  inputContainer.querySelector('.w-full').classList.remove('max-w-4xl', 'lg:max-w-4xl', 'px-4', 'md:px-8');

Â  Â  Â  Â  Â  Â  Â  Â  chatHistory.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  chatHistory.classList.remove('flex', 'pt-20', 'opacity-0');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  setTimeout(scrollToBottom, 50);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function scrollToBottom() {
Â  Â  Â  Â  Â  Â  // Use smooth behavior for a better user experience
Â  Â  Â  Â  Â  Â  chatHistory.scrollTo({
Â  Â  Â  Â  Â  Â  Â  Â  top: chatHistory.scrollHeight,
Â  Â  Â  Â  Â  Â  Â  Â  behavior: 'smooth'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function initSessionId() {
Â  Â  Â  Â  Â  Â  sessionId = localStorage.getItem('sessionId');
Â  Â  Â  Â  Â  Â  if (!sessionId) {
Â  Â  Â  Â  Â  Â  Â  Â  sessionId = crypto.randomUUID();
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('sessionId', sessionId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Typing Effect Implementation ---
Â  Â  Â  Â  async function typeMessage(element, text) {
Â  Â  Â  Â  Â  Â  element.className = element.className
Â  Â  Â  Â  Â  Â  Â  Â  .replace('w-24', 'max-w-3xl')Â 
Â  Â  Â  Â  Â  Â  Â  Â  .replace('p-3', 'p-4');Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  element.classList.add('border', 'border-white/10', 'shadow-liquid', 'ai-message-content'); // ADDED ai-message-content class

Â  Â  Â  Â  Â  Â  // Convert the full markdown text to HTML first
Â  Â  Â  Â  Â  Â  const fullHtml = await parseMarkdown(text);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Create a temporary container to split the HTML into word elements
Â  Â  Â  Â  Â  Â  const tempDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  tempDiv.innerHTML = fullHtml;

Â  Â  Â  Â  Â  Â  // Get all text content and split into words/whitespace for typing
Â  Â  Â  Â  Â  Â  // NOTE: This is a simplified approach for word-by-word typing on complex HTML.
Â  Â  Â  Â  Â  Â  // For basic formatting (strong, em, code, p), it mostly works by typing out
Â  Â  Â  Â  Â  Â  // the inner text of the resulting HTML structure.
Â  Â  Â  Â  Â  Â  const words = text.split(/(\s+)/).filter(p => p.length > 0);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  element.innerHTML = ''; // Clear existing content (the loading dots)

Â  Â  Â  Â  Â  Â  let index = 0;
Â  Â  Â  Â  Â  Â  let scrollCounter = 0;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  scrollToBottom();Â 

Â  Â  Â  Â  Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  Â  Â  Â  Â  function writeWord() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (index < words.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const word = words[index];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // We can't type word-by-word on the rendered HTML structure directly
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // without a much more complex DOM manipulation approach.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // For simplicity and to show the formatted result, we'll append the word
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // as plain text and then render the full HTML at the end of the typing.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // OR, we can do a simplified typing using the initial HTML structure:

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Simplified approach: Type out plain text of the word, then replace with HTML at the end.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // This ensures the typing effect is preserved.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element.textContent += word;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scrollCounter++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (scrollCounter % 5 === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  index++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(writeWord, TYPING_SPEED_MS);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FINALLY: Replace the plain text with the rendered HTML
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element.innerHTML = fullHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  writeWord();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function addMessageToUI(message, role, isPending = false) {
Â  Â  Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  const contentContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const baseBubbleClasses = "rounded-3xl text-text-light whitespace-pre-wrap shadow-lg transition-all duration-300 ease-in-out";

Â  Â  Â  Â  Â  Â  if (role === 'ai') {
Â  Â  Â  Â  Â  Â  Â  Â  wrapper.className = 'w-full py-3 flex justify-start px-4 md:px-8';Â 

Â  Â  Â  Â  Â  Â  Â  Â  if (isPending) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.className = `${baseBubbleClasses} bg-glass-ai p-3 w-24`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="dot dot-1"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="dot dot-2"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="dot dot-3"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.id = 'ai-pending-message';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.className = `${baseBubbleClasses} bg-glass-ai max-w-3xl p-4 border border-white/10 shadow-liquid ai-message-content`;Â  // ADDED ai-message-content
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If not pending, it's a historical message, so we render the final HTML immediately
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parseMarkdown(message).then(html => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.innerHTML = html;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  wrapper.className = 'w-full py-3 flex justify-end px-4 md:px-8';
Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.className = `${baseBubbleClasses} bg-accent-purple max-w-3xl p-4 text-white shadow-glow-lg`;
Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.textContent = message;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  wrapper.appendChild(contentContainer);
Â  Â  Â  Â  Â  Â  chatHistory.appendChild(wrapper);
Â  Â  Â  Â  Â  Â  scrollToBottom();Â 
Â  Â  Â  Â  Â  Â  return isPending ? contentContainer : null;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleChat() {
Â  Â  Â  Â  Â  Â  const message = messageInput.value.trim();
Â  Â  Â  Â  Â  Â  if (!message) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const isFirstMessage = !isChatActive;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  messageInput.value = '';
Â  Â  Â  Â  Â  Â  resizeTextarea();Â 
Â  Â  Â  Â  Â  Â  messageInput.disabled = true;
Â  Â  Â  Â  Â  Â  sendButton.disabled = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isFirstMessage) {
Â  Â  Â  Â  Â  Â  Â  Â  updateUIState(true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  addMessageToUI(message, 'user');
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (message.length > MAX_MESSAGE_LENGTH) {
Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = `No cap, that's too much text (max ${MAX_MESSAGE_LENGTH} characters). Keep it brief, fam. ðŸš«`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const pendingBubble = addMessageToUI('', 'ai', true);Â 
Â  Â  Â  Â  Â  Â  Â  Â  await typeMessage(pendingBubble, errorMsg);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (pendingBubble) pendingBubble.id = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  resizeTextarea();Â 
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const pendingBubble = addMessageToUI('', 'ai', true);
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetchWithRetry(WORKER_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ message, sessionId })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let aiReply = "icls, the server be mad sus rn. check console for tea. ðŸ’€";
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (result.reply) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiReply = result.reply;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (result.error && result.error.message) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiReply = `crap! api got cooked: ${result.error.error.message.substring(0, 100)}... ðŸ˜­`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await typeMessage(pendingBubble, aiReply);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fetch Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  pendingBubble.className = pendingBubble.className
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace('w-24', 'max-w-3xl')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace('p-3', 'p-4');Â 
Â  Â  Â  Â  Â  Â  Â  Â  pendingBubble.classList.add('border', 'border-white/10', 'shadow-liquid');
Â  Â  Â  Â  Â  Â  Â  Â  pendingBubble.innerHTML = `fam, connection busted. no cap. check ur console. ðŸ’€`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  // 7. Cleanup
Â  Â  Â  Â  Â  Â  Â  Â  if (pendingBubble) pendingBubble.id = '';
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  resizeTextarea();Â 
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  // Auto-resizing textarea
Â  Â  Â  Â  function resizeTextarea() {
Â  Â  Â  Â  Â  Â  messageInput.style.height = 'auto';
Â  Â  Â  Â  Â  Â  messageInput.style.height = messageInput.scrollHeight + 'px';
Â  Â  Â  Â  Â  Â  sendButton.disabled = messageInput.value.trim() === '';
Â  Â  Â  Â  }

Â  Â  Â  Â  // Exponential backoff for API robustness
Â  Â  Â  Â  async function fetchWithRetry(url, options, retries = MAX_RETRIES) {
Â  Â  Â  Â  Â  Â  for (let i = 0; i < retries; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url, options);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return response;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.status === 403) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error("Forbidden: Access blocked by CORS policy (incorrect origin).");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Attempt ${i + 1} failed:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const delay = BASE_DELAY_MS * Math.pow(2, i);
Â  Â  Â  Â  Â  Â  Â  Â  if (i < retries - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  throw new Error(`Failed to fetch from ${url} after ${retries} attempts.`);
Â  Â  Â  Â  }

Â  Â  Â  Â  window.onload = function() {
Â  Â  Â  Â  Â  Â  initSessionId();
Â  Â  Â  Â  Â  Â  messageInput.focus();
Â  Â  Â  Â  Â  Â  resizeTextarea();
Â  Â  Â  Â  Â  Â  updateUIState(false);Â 
Â  Â  Â  Â  };
Â  Â  </script>
</body>
</html>
