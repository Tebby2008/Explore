<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVYSTUDY Editor</title>
    
    <!-- MathLive Library -->
    <script src="https://unpkg.com/mathlive"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Mermaid JS (Flowcharts) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <!-- Chart.js (Charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Desmos API -->
    <script src="https://www.desmos.com/api/v1.9/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --blur: blur(12px);
            
            --primary: #007AFF; 
            --primary-glow: rgba(0, 122, 255, 0.3);
            --chem: #34C759; 
            --danger: #FF3B30; 
            --text: #1d1d1f;
            --bg-app: #f5f5f7;
            
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            background-color: var(--bg-app);
            background-image: radial-gradient(circle at 50% -20%, #e0e7ff 0%, #f5f5f7 40%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: scroll; 
        }

        /* --- Global Keyboard Tweaks --- */
        math-virtual-keyboard {
            --keyboard-padding-bottom: 50px;
            --keyboard-zindex: 3000;
        }
        
        .action.warning { color: var(--danger) !important; }
        math-field.chem-field { --math-font-style: normal; }

        /* --- Toolbar --- */
        .toolbar-container {
            position: sticky;
            top: 20px;
            z-index: 1000;
            margin-bottom: 10px;
            margin-top: 20px;
            width: fit-content;
        }

        .toolbar {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            padding: 10px 14px;
            border-radius: 50px;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            display: flex;
            gap: 6px;
            align-items: center;
            user-select: none;
            transition: var(--transition);
        }

        .toolbar:hover {
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
            transform: translateY(-2px);
        }

        .tool-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            color: #555;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
        }
        
        .tool-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
            color: var(--text);
            transform: scale(1.1);
        }

        .tool-btn:active { transform: scale(0.95); }

        .tool-btn.active-state {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-math:hover { color: var(--primary); }
        .btn-chem:hover { color: var(--chem); }

        .tool-btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            color: white;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 4000;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }

        @keyframes fadeIn { to { opacity: 1; transform: translateX(-50%) translateY(-5px); } }
        .divider { width: 1px; height: 24px; background: rgba(0,0,0,0.1); margin: 0 6px; }

        /* --- Insert Menu Dropdown (Hoverable) --- */
        .insert-menu-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            padding-bottom: 20px; 
            margin-bottom: -20px;
        }
        
        .insert-options {
            position: absolute;
            top: 100%; 
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            padding: 8px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: none;
        }

        .insert-menu-wrapper:hover .insert-options, .insert-menu-wrapper.active .insert-options {
            opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); pointer-events: auto;
        }

        /* --- Dropdown for Styles --- */
        .custom-select-wrapper { position: relative; min-width: 130px; }
        .custom-select-trigger {
            padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.5);
            border: 1px solid transparent; cursor: pointer; font-size: 0.9rem;
            font-weight: 500; display: flex; justify-content: space-between; align-items: center;
            transition: var(--transition);
        }
        .custom-select-trigger:hover { background: rgba(255,255,255,0.8); }
        .custom-select-trigger::after { content: '‚ñº'; font-size: 0.6em; margin-left: 10px; color: #888; }
        .custom-options {
            position: absolute; top: 120%; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(15px);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2); overflow: hidden; opacity: 0; visibility: hidden;
            transform: translateY(-10px); transition: var(--transition); z-index: 2000;
        }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 10px 16px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .custom-option:hover { background: var(--primary); color: white; }
        .custom-option.selected { background: rgba(0,0,0,0.05); font-weight: 600; }

        /* --- Editor --- */
        #docTitle {
            background: transparent; border: none; font-size: 2.5rem; font-weight: 700;
            color: var(--text); text-align: center; width: 100%; max-width: 850px;
            margin: 10px 0 20px 0; padding: 10px; outline: none; opacity: 0.5;
            transition: var(--transition); font-family: inherit;
        }
        #docTitle:hover, #docTitle:focus { opacity: 1; }
        #docTitle::placeholder { color: #aaa; font-weight: 500; }

        #editor {
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px);
            width: 100%; max-width: 850px; min-height: 1000px; border-radius: 4px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 80px; box-sizing: border-box;
            outline: none; font-size: 16px; line-height: 1.7; margin-bottom: 50px;
            transition: box-shadow 0.3s;
        }
        #editor:focus { box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        #editor h1 { font-size: 2.2em; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 0.3em; }
        #editor h2 { font-size: 1.6em; color: #333; margin-top: 1.5em; }
        #editor h3 { font-size: 1.3em; color: #555; margin-top: 1.2em; }
        
        /* Lists */
        #editor ul, #editor ol { padding-left: 25px; margin-bottom: 1em; }
        #editor li { margin-bottom: 0.5em; }

        /* --- Block Wrappers (Code & Quote) --- */
        .quote-wrapper, .code-block-wrapper {
            display: block;
            margin: 1.5em 0;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: var(--transition);
        }
        
        /* Quotes */
        .quote-wrapper blockquote {
            border-left: 4px solid var(--primary);
            background: rgba(0,0,0,0.03);
            margin: 0;
            padding: 15px 20px;
            color: #555;
            font-style: italic;
            border-radius: 4px;
            outline: none;
        }

        /* Inline Code */
        .code-wrapper { display: inline-block; vertical-align: baseline; margin: 0 2px; }
        .inline-code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            background: #eef1f5;
            color: #e01e5a;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid rgba(0,0,0,0.05);
            outline: none;
        }
        .inline-code:focus {
            background: white;
            box-shadow: 0 0 0 2px rgba(224, 30, 90, 0.2);
            border-color: #e01e5a;
        }
        
        /* Code Block (Block) */
        .code-block-wrapper pre {
            background: #2d2d2d;
            color: #ccc;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Menlo', 'Monaco', monospace;
            overflow-x: auto;
            margin: 0;
            outline: none;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }
        .code-block-wrapper:hover, .quote-wrapper:hover {
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }

        /* Images & Math */
        #editor img {
            max-width: 100%; border-radius: 8px; cursor: move;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: 0.2s;
        }
        math-field {
            background: rgba(0,0,0,0.04); border-radius: 6px; padding: 2px 8px;
            transition: var(--transition); border: 1px solid transparent; min-width: 30px;
        }
        math-field:focus-within {
            background: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
            transform: scale(1.02); z-index: 10;
        }
        math-field.chem-field { background: rgba(52, 199, 89, 0.1); color: #0c501e; font-style: normal !important; }
        math-field.chem-field:focus-within { box-shadow: 0 4px 12px rgba(52, 199, 89, 0.25); }
        
        .math-wrapper { display: inline-block; vertical-align: middle; margin: 0 2px; }
        .block-container math-field {
            padding: 15px 25px; font-size: 1.3em; background: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px; display: block;
        }

        /* --- Visual Blocks --- */
        .visual-block-wrapper {
            display: block; margin: 20px auto; padding: 20px; border-radius: 12px;
            border: 1px solid transparent; cursor: pointer; transition: var(--transition);
            max-width: 600px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.03); position: relative;
        }
        .visual-block-wrapper:hover {
            background: rgba(0, 122, 255, 0.02); border: 1px dashed rgba(0, 122, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .visual-block-wrapper::after {
            content: 'Double-click to edit'; display: block; font-size: 0.75rem; color: #aaa;
            margin-top: 10px; text-align: center; opacity: 0; transition: 0.2s;
        }
        .visual-block-wrapper:hover::after { opacity: 1; }
        
        .mermaid svg, canvas, .visual-block-wrapper img { max-width: 100%; height: auto !important; display: block; }
        .desmos-wrapper img { border-radius: 8px; border: 1px solid rgba(0,0,0,0.05); }

        /* --- Markscheme --- */
        details.markscheme {
            background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden; margin: 20px 0; border: 1px solid rgba(0,0,0,0.05);
        }
        details.markscheme summary {
            background: rgba(245, 245, 247, 0.8); padding: 12px 20px; cursor: pointer;
            font-weight: 600; transition: 0.2s;
        }
        details.markscheme summary:hover { background: #f0f0f2; }
        .markscheme-content { padding: 20px; }

        /* --- Common Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); padding: 30px;
            border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.4); display: flex; flex-direction: column; gap: 15px;
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal h3 { margin: 0; font-size: 1.2rem; text-align: center; color: #333; }

        /* --- Large Builder Modal --- */
        .modal.large-modal { width: 95vw; height: 90vh; flex-direction: row; padding: 0; overflow: hidden; }
        .modal.desmos-modal { flex-direction: column; padding: 20px; }

        .builder-panel {
            width: 30%; min-width: 320px; background: rgba(250, 250, 252, 0.8);
            border-right: 1px solid rgba(0,0,0,0.1); padding: 20px; display: flex;
            flex-direction: column; gap: 15px; overflow-y: auto;
        }
        .preview-panel {
            width: 70%; padding: 20px; background: white; display: flex;
            align-items: center; justify-content: center; position: relative; overflow: auto;
        }
        #desmosCalculator { width: 100%; height: 100%; border-radius: 12px; overflow: hidden; border: 1px solid #ccc; }
        #tempCalculator { position: absolute; top: -9999px; left: -9999px; width: 600px; height: 400px; visibility: hidden; }

        /* Builder UI Controls */
        .builder-section {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05);
        }
        .builder-header {
            font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .builder-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .builder-input, .builder-select {
            padding: 8px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; flex: 1;
        }
        .btn-icon {
            background: #eee; border: none; width: 32px; height: 32px; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555;
            transition: 0.2s;
        }
        .btn-icon:hover { background: #e0e0e0; color: black; }
        .btn-icon.delete:hover { background: #ffebeb; color: var(--danger); }
        .btn-add-item {
            width: 100%; padding: 8px; border: 1px dashed #ccc; background: transparent;
            border-radius: 8px; color: #666; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        }
        .btn-add-item:hover { border-color: var(--primary); color: var(--primary); background: rgba(0,122,255,0.05); }

        .chart-actions { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }

        .glass-input {
            padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.5); font-size: 1rem; outline: none; transition: 0.2s;
        }
        .glass-input:focus { background: white; border-color: var(--primary); }
        .or-divider { text-align: center; color: #888; font-size: 0.85rem; font-weight: 500; }
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .btn-file-choice {
            border: 2px dashed rgba(0,0,0,0.1); border-radius: 12px; background: rgba(255,255,255,0.4);
            color: #555; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s;
            font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .btn-file-choice:hover { border-color: var(--primary); color: var(--primary); background: rgba(0,122,255,0.05); }
        #imgFileInput { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .modal-actions { display: flex; justify-content: space-between; margin-top: 10px; }
        .btn-glass { padding: 10px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; }
        .btn-glass-cancel { background: rgba(0,0,0,0.05); color: #555; }
        .btn-glass-cancel:hover { background: rgba(0,0,0,0.1); }
        .btn-glass-insert { background: var(--primary); color: white; opacity: 0.5; pointer-events: none; }
        .btn-glass-insert.active { opacity: 1; pointer-events: auto; box-shadow: 0 4px 15px var(--primary-glow); }

        .chart-container-box { width: 100%; max-width: 600px; height: 400px; display: flex; justify-content: center; }

    </style>
</head>
<body>

    <div class="toolbar-container">
        <div class="toolbar">
            <!-- Styles Dropdown -->
            <div class="custom-select-wrapper" id="styleDropdown">
                <div class="custom-select-trigger" onclick="toggleDropdown()">Normal</div>
                <div class="custom-options">
                    <div class="custom-option selected" onclick="selectStyle('p', 'Normal')">Normal</div>
                    <div class="custom-option" onclick="selectStyle('h1', 'Heading 1')">Heading 1</div>
                    <div class="custom-option" onclick="selectStyle('h2', 'Heading 2')">Heading 2</div>
                    <div class="custom-option" onclick="selectStyle('h3', 'Heading 3')">Heading 3</div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Formatting -->
            <button class="tool-btn" id="btnBold" onclick="toggleFormat('bold')" title="Bold"><i class="ph ph-text-b"></i></button>
            <button class="tool-btn" id="btnItalic" onclick="toggleFormat('italic')" title="Italic"><i class="ph ph-text-italic"></i></button>
            <button class="tool-btn" id="btnUnderline" onclick="toggleFormat('underline')" title="Underline"><i class="ph ph-text-underline"></i></button>
            
            <div class="divider"></div>

            <!-- Math & Chem -->
            <button class="tool-btn btn-math" onclick="insertMath('inline')" title="Inline Math"><i class="ph ph-sigma"></i></button>
            <button class="tool-btn btn-math" onclick="insertMath('block')" title="Block Math"><i class="ph ph-sigma" style="font-weight:bold; border: 2px solid currentColor; border-radius: 4px; padding: 2px; font-size: 0.8rem;"></i></button>

            <div class="divider"></div>

            <button class="tool-btn btn-chem" onclick="insertChem('inline')" title="Inline Chem"><i class="ph ph-flask"></i></button>
            <button class="tool-btn btn-chem" onclick="insertChem('block')" title="Block Chem"><i class="ph ph-flask" style="font-weight:bold; border: 2px solid currentColor; border-radius: 4px; padding: 2px; font-size: 0.8rem;"></i></button>

            <div class="divider"></div>

            <!-- Insert Menu (Hoverable) -->
            <div class="insert-menu-wrapper">
                <button class="tool-btn" title="Insert..."><i class="ph ph-plus"></i></button>
                <div class="insert-options">
                    <!-- New Features Requested -->
                    <button class="tool-btn" onclick="insertList('ul')" title="Bullet List"><i class="ph ph-list-bullets"></i></button>
                    <button class="tool-btn" onclick="insertList('ol')" title="Numbered List"><i class="ph ph-list-numbers"></i></button>
                    <button class="tool-btn" onclick="insertQuote()" title="Quote"><i class="ph ph-quotes"></i></button>
                    <button class="tool-btn" onclick="insertInlineCode()" title="Inline Code"><i class="ph ph-code"></i></button>
                    <button class="tool-btn" onclick="insertCodeBlock()" title="Code Block"><i class="ph ph-code-block"></i></button>
                    
                    <div class="divider"></div>
                    
                    <!-- Original Heavy Inserts -->
                    <button class="tool-btn" onclick="openImageModal()" title="Image"><i class="ph ph-image"></i></button>
                    <button class="tool-btn" onclick="openFlowchartModal()" title="Flowchart"><i class="ph ph-tree-structure"></i></button>
                    <button class="tool-btn" onclick="openChartJsModal()" title="Chart"><i class="ph ph-chart-bar"></i></button>
                    <button class="tool-btn" onclick="openDesmosModal()" title="Calculator"><i class="ph ph-calculator"></i></button>
                    <button class="tool-btn" onclick="insertMarkscheme()" title="Markscheme"><i class="ph ph-list-checks"></i></button>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Import/Export -->
            <button class="tool-btn" onclick="document.getElementById('mdUploadInput').click()" title="Import Markdown"><i class="ph ph-upload-simple"></i></button>
            <input type="file" id="mdUploadInput" accept=".md" style="display:none" onchange="importMarkdown(this)">
            
            <button class="tool-btn" onclick="downloadMarkdown()" title="Download Markdown"><i class="ph ph-download-simple"></i></button>
        </div>
    </div>

    <!-- Title Input -->
    <input type="text" id="docTitle" placeholder="Untitled Note" spellcheck="false" autocomplete="off">

    <!-- The Paper -->
    <div id="editor" contenteditable="true" spellcheck="false">
        <h1>Markdown Creator</h1>
        <p>Start typing here...</p>
    </div>

    <!-- Hidden Temp Calculator for Screenshot Generation -->
    <div id="tempCalculator"></div>

    <!-- Image Modal -->
    <div id="imgModal" class="modal-overlay">
        <div class="modal">
            <h3>Add Media</h3>
            <input type="text" class="glass-input" id="imgUrlInput" placeholder="Paste image URL here..." oninput="checkImgInput()">
            <div class="or-divider">OR</div>
            <div class="file-upload-wrapper">
                <div class="btn-file-choice">
                    <i class="ph ph-upload-simple"></i>
                    <span id="fileNameDisplay">Click to upload from device</span>
                </div>
                <input type="file" id="imgFileInput" accept="image/*" onchange="handleFileSelect()">
            </div>
            <div class="modal-actions">
                <button class="btn-glass btn-glass-cancel" onclick="closeImageModal()">Cancel</button>
                <button id="btnInsertImg" class="btn-glass btn-glass-insert" onclick="confirmInsertImage()">Insert Image</button>
            </div>
        </div>
    </div>

    <!-- Flowchart Builder Modal -->
    <div id="chartModal" class="modal-overlay">
        <div class="modal large-modal">
            <div class="builder-panel">
                <h3>Flowchart Builder</h3>
                <p style="font-size:0.8rem; color:#666;">Add nodes, then connect them.</p>
                <div class="builder-section">
                    <div class="builder-header">Nodes</div>
                    <div id="nodesList"></div>
                    <button class="btn-add-item" onclick="addChartNode()"><i class="ph ph-plus"></i> Add Node</button>
                </div>
                <div class="builder-section">
                    <div class="builder-header">Connections</div>
                    <div id="connectionsList"></div>
                    <button class="btn-add-item" onclick="addChartConnection()"><i class="ph ph-plus"></i> Add Connection</button>
                </div>
                <div style="flex:1"></div>
                <button class="btn-glass btn-glass-cancel" onclick="closeFlowchartModal()">Cancel</button>
            </div>
            <div class="preview-panel">
                <div id="chartPreview"></div>
                <div class="chart-actions">
                    <button class="btn-glass btn-glass-insert active" onclick="confirmInsertChart()">Insert Diagram</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js Builder Modal -->
    <div id="chartJsModal" class="modal-overlay">
        <div class="modal large-modal">
            <div class="builder-panel">
                <h3>Chart Builder</h3>
                <p style="font-size:0.8rem; color:#666;">Configure your chart data.</p>
                <div class="builder-section">
                    <div class="builder-header">Settings</div>
                    <div class="builder-row">
                        <select id="cjsType" class="builder-select" onchange="updateChartJsPreview()">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="pie">Pie Chart</option>
                            <option value="doughnut">Doughnut Chart</option>
                        </select>
                    </div>
                    <div class="builder-row">
                        <input type="text" id="cjsTitle" class="builder-input" placeholder="Chart Title" oninput="updateChartJsPreview()">
                    </div>
                    <div class="builder-row">
                        <input type="text" id="cjsDatasetLabel" class="builder-input" placeholder="Dataset Label (e.g. Sales)" value="Data" oninput="updateChartJsPreview()">
                    </div>
                </div>
                <div class="builder-section">
                    <div class="builder-header">Data Points (Label | Value)</div>
                    <div id="cjsDataList"></div>
                    <button class="btn-add-item" onclick="addChartJsPoint()"><i class="ph ph-plus"></i> Add Point</button>
                </div>
                <div style="flex:1"></div>
                <button class="btn-glass btn-glass-cancel" onclick="closeChartJsModal()">Cancel</button>
            </div>
            <div class="preview-panel">
                <div class="chart-container-box">
                    <canvas id="cjsPreviewCanvas"></canvas>
                </div>
                <div class="chart-actions">
                    <button class="btn-glass btn-glass-insert active" onclick="confirmInsertChartJs()">Insert Chart</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Desmos Modal -->
    <div id="desmosModal" class="modal-overlay">
        <div class="modal large-modal desmos-modal">
            <div style="flex:1; position:relative;">
                <div id="desmosCalculator"></div>
                <div class="chart-actions">
                    <button class="btn-glass btn-glass-cancel" style="background: white;" onclick="closeDesmosModal()">Cancel</button>
                    <button class="btn-glass btn-glass-insert active" onclick="confirmInsertDesmos()">Insert Graph</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log(`       
                ============================================================
                ‚ö†Ô∏è DESMOS API DISCLAIMER ‚Äì REQUIRED NOTICE ‚ö†Ô∏è
                ============================================================

                This project references or utilizes elements of the Desmos Graphing Calculator
                or its API. Please be aware of the following critical usage restrictions:

                1. Desmos does NOT offer public or open access to their API.
                Any integration beyond their public graphing calculator embed
                must be explicitly approved through Desmos‚Äôs official Partnership Program.

                2. API keys and advanced features (e.g., programmatic graph creation,
                data syncing, deep integrations) require PRIOR authorization.

                3. Unauthorized use of the Desmos API‚Äîincluding accessing endpoints
                without permission, reverse engineering, scraping, or automated access‚Äî
                is strictly forbidden and may violate Desmos‚Äôs Terms of Service.

                4. If you wish to use the Desmos API legally and safely, you MUST:
                - Apply at https://www.desmos.com/partners
                - Receive approval and credentials from Desmos, Inc.
                - Follow all relevant documentation and branding guidelines

                5. This project is NOT affiliated with or endorsed by Desmos, Inc.
                All trademarks and services belong to their respective owners.

                Failure to comply with these terms can result in:
                - API access revocation
                - Legal action
                - Application malfunction or incompatibility
                - User data loss or privacy violations

                üîó Official API access: https://www.desmos.com/partners
                üîó Terms of Service: https://www.desmos.com/terms
                üîó Privacy Policy: https://www.desmos.com/privacy

                DO NOT use the Desmos API in production or distributed applications
                without explicit permission from Desmos.

                ============================================================


        `);
        // --- 1. Constants & Init ---
        mermaid.initialize({ startOnLoad: false, theme: 'neutral', flowchart: { htmlLabels: true, curve: 'basis' } });

        const CHEM_LAYOUT = {
            label: "Chem", tooltip: "Chemistry",
            rows: [[{ label: "1", key: "1" }, { label: "2", key: "2" }, { label: "3", key: "3" }, { label: "4", key: "4" }, { label: "5", key: "5" }, { label: "+", key: "+" }, { label: "‚àí", key: "-" }, { label: "=", key: "=" }, { label: "‚ü∂", latex: "\\longrightarrow" }, { label: "‚áå", latex: "\\rightleftharpoons" }], [{ label: "6", key: "6" }, { label: "7", key: "7" }, { label: "8", key: "8" }, { label: "9", key: "9" }, { label: "0", key: "0" }, { label: "(", key: "(" }, { label: ")", key: ")" }, { label: "<span>‚óª</span><sup><span>‚óª</span></sup>", latex: "^{#?}" }, { label: "<span>‚óª</span><sub><span>‚óª</span></sub>", latex: "_{#?}" }, { label: "Sup/Sub", latex: "_{#?}^{#?}" }], [{ label: "e‚Åª", latex: "e^-" }, { label: "H‚Å∫", latex: "H^+" }, { label: "Œî", latex: "\\Delta" }, { label: "mol", latex: "\\text{mol}" }, { label: "(s)", latex: "_{(s)}" }, { label: "(l)", latex: "_{(l)}" }, { label: "(g)", latex: "_{(g)}" }, { label: "(aq)", latex: "_{(aq)}" }, { class: "action", label: "‚å´", command: ["performWithFeedback", "deleteBackward"] }, { class: "action warning", label: "üóë", command: "deleteEquation" }]]
        };

        const editor = document.getElementById('editor');
        const imgModal = document.getElementById('imgModal');
        const imgUrlInput = document.getElementById('imgUrlInput');
        const imgFileInput = document.getElementById('imgFileInput');
        const btnInsertImg = document.getElementById('btnInsertImg');
        const docTitle = document.getElementById('docTitle');
        let savedRange = null;

        // --- Keyboard Logic ---
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof MathfieldElement !== 'undefined') {
                MathfieldElement.commands.deleteEquation = (mf) => {
                    const parent = mf.parentElement;
                    if (parent) { setTimeout(() => { if(parent.classList.contains('math-wrapper')) parent.remove(); else if(parent.classList.contains('block-container')) parent.remove(); else mf.remove(); editor.focus(); }, 10); } return true;
                };
            }
        });
        document.addEventListener('focusin', (e) => { if (e.target.tagName && e.target.tagName.toLowerCase() === 'math-field') { updateKeyboardLayout(e.target); if (window.mathVirtualKeyboard) window.mathVirtualKeyboard.show(); } });
        document.addEventListener('focusout', (e) => { if (e.target.tagName && e.target.tagName.toLowerCase() === 'math-field') { setTimeout(() => { if (!document.activeElement || document.activeElement.tagName.toLowerCase() !== 'math-field') { if (window.mathVirtualKeyboard) window.mathVirtualKeyboard.hide(); } }, 50); } });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { if (window.mathVirtualKeyboard) window.mathVirtualKeyboard.hide(); closeImageModal(); closeFlowchartModal(); closeChartJsModal(); closeDesmosModal(); document.querySelectorAll('.insert-menu-wrapper').forEach(el => el.classList.remove('active')); document.activeElement.blur(); }
        });
        window.addEventListener('click', (e) => { const w = document.querySelector('.insert-menu-wrapper'); if (w && !w.contains(e.target)) w.classList.remove('active'); const d = document.getElementById('styleDropdown'); if (d && !d.contains(e.target)) d.classList.remove('open'); });
        function updateKeyboardLayout(target) { if (!window.mathVirtualKeyboard) return; if (target.classList.contains('chem-field')) window.mathVirtualKeyboard.layouts = [CHEM_LAYOUT]; else window.mathVirtualKeyboard.layouts = "default"; }

        // --- Editor Helpers ---
        const dropdownTrigger = document.querySelector('.custom-select-trigger');
        const options = document.querySelectorAll('.custom-option');
        function toggleDropdown() { document.getElementById('styleDropdown').classList.toggle('open'); }
        function selectStyle(tag, label) { document.execCommand('formatBlock', false, tag); dropdownTrigger.childNodes[0].nodeValue = label; options.forEach(opt => opt.classList.remove('selected')); event.target.classList.add('selected'); document.getElementById('styleDropdown').classList.remove('open'); editor.focus(); }
        function toggleFormat(cmd) { document.execCommand(cmd, false, null); editor.focus(); checkFormatState(); }
        function checkFormatState() {
            document.getElementById('btnBold').classList.toggle('active-state', document.queryCommandState('bold'));
            document.getElementById('btnItalic').classList.toggle('active-state', document.queryCommandState('italic'));
            document.getElementById('btnUnderline').classList.toggle('active-state', document.queryCommandState('underline'));
        }
        document.addEventListener('selectionchange', () => { if (document.activeElement === editor || editor.contains(document.activeElement)) checkFormatState(); });
        document.execCommand('defaultParagraphSeparator', false, 'p');

        // --- New Formatting Functions ---
        function insertList(type) {
            if(type === 'ul') document.execCommand('insertUnorderedList', false, null);
            if(type === 'ol') document.execCommand('insertOrderedList', false, null);
            editor.focus();
        }

        function insertQuote() {
            document.querySelector('.insert-menu-wrapper').classList.remove('active');
            const wrapper = document.createElement('div');
            wrapper.className = "quote-wrapper";
            wrapper.contentEditable = "false";

            const bq = document.createElement('blockquote');
            bq.contentEditable = "true";
            bq.innerText = "Quote text...";

            wrapper.appendChild(bq);
            insertNodeAtCursor(wrapper);
            wrapperAfter(wrapper);
            
            setTimeout(() => { bq.focus(); }, 10);
        }

        function insertCodeBlock() {
            document.querySelector('.insert-menu-wrapper').classList.remove('active');
            const wrapper = document.createElement('div');
            wrapper.className = "code-block-wrapper";
            wrapper.contentEditable = "false";

            const pre = document.createElement('pre');
            pre.contentEditable = "true";
            pre.innerText = "Code...";
            
            wrapper.appendChild(pre);
            insertNodeAtCursor(wrapper);
            wrapperAfter(wrapper);
            
            setTimeout(() => { pre.focus(); }, 10);
        }

        function insertInlineCode() {
            const wrapper = document.createElement('span');
            wrapper.className = 'code-wrapper';
            wrapper.contentEditable = "false";
            
            const code = document.createElement('span');
            code.className = 'inline-code';
            code.contentEditable = "true";
            code.innerText = "code";
            
            wrapper.appendChild(code);
            
            const z1 = document.createTextNode('\u200B'); 
            const z2 = document.createTextNode('\u200B');
            
            insertNodeAtCursor(z2); 
            insertNodeAtCursor(wrapper); 
            insertNodeAtCursor(z1);
            
            setTimeout(() => {
                const range = document.createRange();
                range.selectNodeContents(code);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }, 10);
        }

        function createField(type) {
            const mf = new MathfieldElement(); mf.mathVirtualKeyboardPolicy = "manual"; 
            mf.addEventListener('focus-out', (ev) => { if (ev.detail.direction === 'forward') { const w = mf.parentElement; if (w && w.classList.contains('math-wrapper') && w.nextSibling) { const r = document.createRange(); r.setStart(w.nextSibling, 0); r.collapse(true); const s = window.getSelection(); s.removeAllRanges(); s.addRange(r); } } });
            if (type === 'chem') { mf.classList.add('chem-field'); mf.setAttribute('letter-shape-style', 'upright'); } else { mf.classList.add('math-field'); } return mf;
        }

        function insertMath(mode) { insertField('math', mode); }
        function insertChem(mode) { insertField('chem', mode); }
        function insertField(type, mode) {
            const mf = createField(type); mf.value = type === 'chem' ? "" : "x";
            if (mode === 'inline') {
                const wrapper = document.createElement('span'); wrapper.className = 'math-wrapper'; wrapper.contentEditable = "false"; wrapper.appendChild(mf);
                const z1 = document.createTextNode('\u200B'); const z2 = document.createTextNode('\u200B');
                insertNodeAtCursor(z2); insertNodeAtCursor(wrapper); insertNodeAtCursor(z1);
                setTimeout(() => mf.focus(), 50);
            } else {
                const container = document.createElement('div'); container.className = 'block-container'; container.contentEditable = "false"; container.appendChild(mf);
                insertNodeAtCursor(container); const p = document.createElement('p'); p.innerHTML = "<br>"; container.after(p); setTimeout(() => mf.focus(), 50);
            }
        }
        function saveSelection() { const s = window.getSelection(); if (s.getRangeAt && s.rangeCount) savedRange = (editor.contains(s.anchorNode)) ? s.getRangeAt(0) : null; }
        function restoreSelection() { if (savedRange) { const s = window.getSelection(); s.removeAllRanges(); s.addRange(savedRange); } else editor.focus(); }
        function insertNodeAtCursor(node) { const s = window.getSelection(); if (!s.rangeCount) return; const r = s.getRangeAt(0); r.deleteContents(); r.insertNode(node); r.setStartAfter(node); r.setEndAfter(node); s.removeAllRanges(); s.addRange(r); }

        // --- MERMAID FLOWCHART ---
        const chartModal = document.getElementById('chartModal'); let chartNodes = [], chartEdges = [], editingChartElement = null;
        function openFlowchartModal(data = null) {
            document.querySelector('.insert-menu-wrapper').classList.remove('active'); saveSelection(); chartModal.classList.add('active');
            if (data) { chartNodes = data.nodes; chartEdges = data.edges; } else { chartNodes = [{id:'A',text:'Start',shape:'rect'},{id:'B',text:'End',shape:'rect'}]; chartEdges = [{from:'A',to:'B',text:''}]; }
            renderBuilderUI(); updateChartPreview();
        }
        function closeFlowchartModal() { chartModal.classList.remove('active'); editingChartElement = null; }
        function renderBuilderUI() {
            const nList = document.getElementById('nodesList'), eList = document.getElementById('connectionsList'); nList.innerHTML = ''; eList.innerHTML = '';
            chartNodes.forEach((n, i) => {
                nList.innerHTML += `<div class="builder-row"><select class="builder-select" style="max-width:80px" onchange="updateNodeShape(${i},this.value)"><option value="rect" ${n.shape==='rect'?'selected':''}>Square</option><option value="round" ${n.shape==='round'?'selected':''}>Round</option><option value="diamond" ${n.shape==='diamond'?'selected':''}>Decision</option></select><input type="text" class="builder-input" value="${n.text}" oninput="updateNodeText(${i},this.value)"><button class="btn-icon delete" onclick="removeNode(${i})"><i class="ph ph-trash"></i></button></div>`;
            });
            chartEdges.forEach((e, i) => {
                const ops = chartNodes.map(n => `<option value="${n.id}" ${n.id===e.from?'selected':''}>${n.text.substring(0,15)}</option>`).join('');
                const opsTo = chartNodes.map(n => `<option value="${n.id}" ${n.id===e.to?'selected':''}>${n.text.substring(0,15)}</option>`).join('');
                eList.innerHTML += `<div class="builder-row"><select class="builder-select" onchange="updateEdge(${i},'from',this.value)">${ops}</select><i class="ph ph-arrow-right"></i><select class="builder-select" onchange="updateEdge(${i},'to',this.value)">${opsTo}</select><input type="text" class="builder-input" value="${e.text||''}" placeholder="Label" oninput="updateEdge(${i},'text',this.value)"><button class="btn-icon delete" onclick="removeEdge(${i})"><i class="ph ph-trash"></i></button></div>`;
            });
        }
        function addChartNode(){ chartNodes.push({id:'N'+Date.now().toString().slice(-4),text:'New',shape:'rect'}); renderBuilderUI(); updateChartPreview(); }
        function removeNode(i){ const id=chartNodes[i].id; chartNodes.splice(i,1); chartEdges=chartEdges.filter(e=>e.from!==id&&e.to!==id); renderBuilderUI(); updateChartPreview(); }
        function updateNodeShape(i,v){ chartNodes[i].shape=v; updateChartPreview(); }
        function updateNodeText(i,v){ chartNodes[i].text=v; updateChartPreview(); }
        function addChartConnection(){ if(chartNodes.length>1) chartEdges.push({from:chartNodes[0].id,to:chartNodes[1].id,text:''}); renderBuilderUI(); updateChartPreview(); }
        function removeEdge(i){ chartEdges.splice(i,1); renderBuilderUI(); updateChartPreview(); }
        function updateEdge(i,k,v){ chartEdges[i][k]=v; updateChartPreview(); }
        async function updateChartPreview() { document.getElementById('chartPreview').innerHTML = `<div class="mermaid">${generateMermaidCode()}</div>`; try{ await mermaid.run({nodes:[document.querySelector('#chartPreview .mermaid')]}); }catch(e){} }
        function generateMermaidCode() {
            let c="graph TD\nclassDef default fill:#fff,stroke:#333,stroke-width:1px;\n";
            chartNodes.forEach(n=>{ let s="[",e="]"; if(n.shape==='round'){s="(";e=")";}if(n.shape==='diamond'){s="{";e="}";} c+=`${n.id}${s}"${n.text.replace(/"/g,"'")}"${e}\n`; });
            chartEdges.forEach(e=>{ c+=`${e.from} -->${e.text?`|"${e.text}"|`:''} ${e.to}\n`; }); return c;
        }
        async function confirmInsertChart() {
            const c=generateMermaidCode(), s=JSON.stringify({nodes:chartNodes,edges:chartEdges});
            if(editingChartElement){ editingChartElement.dataset.source=c; editingChartElement.dataset.state=s; editingChartElement.innerHTML=c; editingChartElement.removeAttribute('data-processed'); await mermaid.run({nodes:[editingChartElement]}); closeFlowchartModal(); return; }
            restoreSelection(); const w=document.createElement('div'); w.className='visual-block-wrapper mermaid-wrapper mermaid'; w.contentEditable="false"; w.dataset.source=c; w.dataset.state=s; w.innerHTML=c; insertNodeAtCursor(w); wrapperAfter(w); await mermaid.run({nodes:[w]}); closeFlowchartModal();
        }

        // --- CHART.JS ---
        const chartJsModal = document.getElementById('chartJsModal'), cjsCanvas = document.getElementById('cjsPreviewCanvas');
        let cjsInstance = null, cjsData = {type:'bar',title:'',label:'Data',points:[]}, editingCjsElement = null;
        function openChartJsModal(data=null) {
            document.querySelector('.insert-menu-wrapper').classList.remove('active'); saveSelection(); chartJsModal.classList.add('active');
            if(data) cjsData=data; else cjsData={type:'bar',title:'',label:'Dataset',points:[{label:'A',value:10},{label:'B',value:20}]};
            document.getElementById('cjsType').value=cjsData.type; document.getElementById('cjsTitle').value=cjsData.title; document.getElementById('cjsDatasetLabel').value=cjsData.label; renderChartJsBuilder(); updateChartJsPreview();
        }
        function closeChartJsModal() { chartJsModal.classList.remove('active'); editingCjsElement=null; if(cjsInstance){cjsInstance.destroy();cjsInstance=null;} }
        function renderChartJsBuilder() {
            const l=document.getElementById('cjsDataList'); l.innerHTML=''; cjsData.points.forEach((p,i)=>{ l.innerHTML+=`<div class="builder-row"><input class="builder-input" value="${p.label}" oninput="updateCjsPoint(${i},'label',this.value)"><input type="number" class="builder-input" value="${p.value}" oninput="updateCjsPoint(${i},'value',this.value)"><button class="btn-icon delete" onclick="removeCjsPoint(${i})"><i class="ph ph-trash"></i></button></div>`; });
        }
        function addChartJsPoint(){ cjsData.points.push({label:'New',value:0}); renderChartJsBuilder(); updateChartJsPreview(); }
        function removeCjsPoint(i){ cjsData.points.splice(i,1); renderChartJsBuilder(); updateChartJsPreview(); }
        function updateCjsPoint(i,k,v){ cjsData.points[i][k]=(k==='value')?parseFloat(v)||0:v; updateChartJsPreview(); }
        function getChartColors(n,t){ const c=['rgba(255,99,132,0.6)','rgba(54,162,235,0.6)','rgba(255,206,86,0.6)','rgba(75,192,192,0.6)','rgba(153,102,255,0.6)','rgba(255,159,64,0.6)']; const b=c.map(s=>s.replace('0.6','1')); if(t==='line') return {bg:c[1],bd:b[1]}; const bg=[],bd=[]; for(let i=0;i<n;i++){bg.push(c[i%6]);bd.push(b[i%6]);} return {bg,bd}; }
        function updateChartJsPreview() {
            cjsData.type=document.getElementById('cjsType').value; cjsData.title=document.getElementById('cjsTitle').value; cjsData.label=document.getElementById('cjsDatasetLabel').value;
            if(cjsInstance) cjsInstance.destroy(); const l=cjsData.points.map(p=>p.label), d=cjsData.points.map(p=>p.value), c=getChartColors(d.length,cjsData.type);
            const cfg={type:cjsData.type,data:{labels:l,datasets:[{label:cjsData.label,data:d,backgroundColor:c.bg,borderColor:c.bd,borderWidth:1,tension:0.1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:!!cjsData.title,text:cjsData.title},legend:{display:cjsData.type!=='bar'}}}};
            cjsInstance=new Chart(cjsCanvas,cfg);
        }
        function confirmInsertChartJs() {
            const l=cjsData.points.map(p=>p.label), d=cjsData.points.map(p=>p.value), c=getChartColors(d.length,cjsData.type);
            const cfg={type:cjsData.type,data:{labels:l,datasets:[{label:cjsData.label,data:d,backgroundColor:c.bg,borderColor:c.bd,borderWidth:1}]},options:{plugins:{title:{display:!!cjsData.title,text:cjsData.title}}}};
            if(cjsData.type==='line'){cfg.data.datasets[0].tension=0.1;cfg.data.datasets[0].fill=false;}
            const s=JSON.stringify(cjsData), e=JSON.stringify(cfg,null,2);
            if(editingCjsElement){ editingCjsElement.dataset.state=s; editingCjsElement.dataset.export=e; const cv=editingCjsElement.querySelector('canvas'); const ci=Chart.getChart(cv); if(ci)ci.destroy(); new Chart(cv,cfg); closeChartJsModal(); return; }
            restoreSelection(); const w=document.createElement('div'); w.className='visual-block-wrapper chart-wrapper'; w.contentEditable="false"; w.dataset.state=s; w.dataset.export=e; const cv=document.createElement('canvas'); cv.style.maxHeight="400px"; w.appendChild(cv); insertNodeAtCursor(w); wrapperAfter(w); new Chart(cv,cfg); closeChartJsModal();
        }

        // --- DESMOS ---
        const desmosModal = document.getElementById('desmosModal'); let calculator = null, editingDesmosElement = null;
        function openDesmosModal(state = null) {
            document.querySelector('.insert-menu-wrapper').classList.remove('active'); saveSelection(); desmosModal.classList.add('active');
            if(calculator) { calculator.destroy(); calculator=null; }
            calculator = Desmos.GraphingCalculator(document.getElementById('desmosCalculator'), {settingsMenu:true,expressions:true});
            if(state) {
                if(state.config){ const c=state.config; if(c.bounds) calculator.setMathBounds({left:c.bounds.x[0],right:c.bounds.x[1],bottom:c.bounds.y[0],top:c.bounds.y[1]}); calculator.updateSettings({showGrid:c.grid!==false,showXAxis:c.showXAxis!==false,showYAxis:c.showYAxis!==false,xAxisLabel:c.xAxisLabel||'',yAxisLabel:c.yAxisLabel||''}); }
                if(state.expressions) calculator.setExpressions(state.expressions.map(l=>({latex:l})));
            } else calculator.setExpression({id:'1',latex:'y=x^2'});
        }
        function closeDesmosModal() { desmosModal.classList.remove('active'); editingDesmosElement=null; if(calculator){calculator.destroy();calculator=null;} }
        function confirmInsertDesmos() {
            const s=calculator.getState(), b=calculator.graphpaperBounds.mathCoordinates, st=calculator.graphSettings;
            const exprs=s.expressions.list.filter(e=>e.type==='expression'&&e.latex).map(e=>e.latex);
            const cfg={bounds:{x:[b.left,b.right],y:[b.bottom,b.top]},grid:st.showGrid,showXAxis:st.showXAxis,showYAxis:st.showYAxis,xAxisLabel:st.xAxisLabel,yAxisLabel:st.yAxisLabel};
            const json=JSON.stringify({expressions:exprs,config:cfg});
            const shot=calculator.screenshot({width:600,height:400,targetPixelRatio:2});
            if(editingDesmosElement){ editingDesmosElement.dataset.state=json; editingDesmosElement.querySelector('img').src=shot; closeDesmosModal(); return; }
            restoreSelection(); const w=document.createElement('div'); w.className='visual-block-wrapper desmos-wrapper'; w.contentEditable="false"; w.dataset.state=json; const img=document.createElement('img'); img.src=shot; img.style.width='100%'; img.style.borderRadius='8px'; w.appendChild(img); insertNodeAtCursor(w); wrapperAfter(w); closeDesmosModal();
        }

        // --- IMAGES ---
        function openImageModal() { document.querySelector('.insert-menu-wrapper').classList.remove('active'); saveSelection(); imgModal.classList.add('active'); imgUrlInput.focus(); checkImgInput(); }
        function closeImageModal() { imgModal.classList.remove('active'); imgUrlInput.value=""; imgFileInput.value=""; document.getElementById('fileNameDisplay').innerText="Click to upload"; checkImgInput(); }
        function handleFileSelect() { if(imgFileInput.files.length) document.getElementById('fileNameDisplay').innerText=imgFileInput.files[0].name; checkImgInput(); }
        function checkImgInput() { btnInsertImg.classList.toggle('active', imgUrlInput.value.trim().length>0 || imgFileInput.files.length>0); }
        function confirmInsertImage() {
            restoreSelection(); if(imgFileInput.files.length){ const r=new FileReader(); r.onload=e=>insertImageTag(e.target.result); r.readAsDataURL(imgFileInput.files[0]); } else if(imgUrlInput.value.trim()) insertImageTag(imgUrlInput.value.trim()); closeImageModal();
        }
        function insertImageTag(src) { const img=document.createElement('img'); img.src=src; insertNodeAtCursor(img); wrapperAfter(img); }

        function wrapperAfter(node) { const p=document.createElement('p'); p.innerHTML="<br>"; node.after(p); }

        editor.addEventListener('dblclick', (e) => {
            let t=e.target; while(t&&t!==editor){
                if(t.classList.contains('mermaid-wrapper')) { editingChartElement=t; return openFlowchartModal(JSON.parse(t.dataset.state)); }
                if(t.classList.contains('chart-wrapper')) { editingCjsElement=t; return openChartJsModal(JSON.parse(t.dataset.state)); }
                if(t.classList.contains('desmos-wrapper')) { editingDesmosElement=t; return openDesmosModal(JSON.parse(t.dataset.state)); }
                t=t.parentElement;
            }
        });

        // --- BACKSPACE & DELETION LOGIC ---
        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace') {
                const s = window.getSelection(); if (!s.rangeCount || !s.isCollapsed) return;
                const anchor = s.anchorNode; const offset = s.anchorOffset;
                
                // 1. Block Deletion (Including Code & Quote wrappers now)
                let block = anchor; 
                while (block && block.parentElement && block.parentElement !== editor) block = block.parentElement;
                
                if (block && s.anchorOffset === 0) { 
                    const p = block.previousElementSibling; 
                    if (p && (p.classList.contains('markscheme') || p.classList.contains('block-container') || p.classList.contains('visual-block-wrapper') || p.classList.contains('code-block-wrapper') || p.classList.contains('quote-wrapper') || p.tagName === 'IMG')) { 
                        e.preventDefault(); p.remove(); return; 
                    } 
                }

                // 2. Math & Inline Code Atomic Deletion
                if (anchor.nodeType === 3) {
                    // Previous Sibling Check (offset 0)
                    if (offset === 0 && anchor.previousSibling) {
                        const prev = anchor.previousSibling;
                        if (prev.classList && (prev.classList.contains('math-wrapper') || prev.classList.contains('code-wrapper'))) {
                            e.preventDefault(); prev.remove(); 
                            return;
                        }
                    }
                    // Invisible Character Check (offset 1) - often around wrappers
                    else if (offset === 1 && anchor.textContent.charCodeAt(0) === 8203 && anchor.previousSibling) {
                         const prev = anchor.previousSibling;
                         if (prev.classList && (prev.classList.contains('math-wrapper') || prev.classList.contains('code-wrapper'))) {
                            e.preventDefault(); prev.remove(); anchor.remove();
                            return;
                         }
                    }
                }
            }
        });

        function insertMarkscheme() {
            document.querySelector('.insert-menu-wrapper').classList.remove('active');
            const d = document.createElement('details'); d.className='markscheme'; d.open=true; d.contentEditable="false"; d.innerHTML=`<summary><span class="summary-title" contenteditable="true">Markscheme</span></summary><div class="markscheme-content" contenteditable="true"><p>Answer...</p></div>`; insertNodeAtCursor(d); wrapperAfter(d); setTimeout(()=>d.querySelector('.summary-title').focus(),10);
        }

        // --- MARKDOWN IMPORT / EXPORT ---
        function downloadMarkdown() {
            let t=docTitle.value.trim(); if(!t)t="Untitled Note";
            const blob=new Blob([parseToMarkdown(editor)], {type:'text/markdown'});
            const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=t.replace(/[^a-z0-9]/gi,'_').toLowerCase()+'.md'; a.click();
        }

        function importMarkdown(input) {
            if (!input.files.length) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                editor.innerHTML = ''; 
                const text = e.target.result;
                const lines = text.split('\n');
                
                let inCodeBlock = false, codeType = '', codeBuffer = [];
                let inMarkscheme = false, markschemeBuffer = [];
                let inMathBlock = false, mathBuffer = [];
                let inList = false;
                let currentListType = null; 
                let listContainer = null;

                for (let i=0; i<lines.length; i++) {
                    let line = lines[i];
                    
                    // --- 1. Code Blocks ---
                    if (line.trim().startsWith('```')) {
                        if (inCodeBlock) {
                            await processCodeBlock(codeType, codeBuffer.join('\n'));
                            inCodeBlock = false; codeBuffer = []; codeType = '';
                        } else {
                            if(inList) { inList = false; listContainer = null; }
                            inCodeBlock = true;
                            codeType = line.trim().replace('```', '').trim();
                        }
                        continue;
                    }
                    if (inCodeBlock) { codeBuffer.push(line); continue; }

                    // --- 2. Math Blocks ($$ ... $$) ---
                    if (line.trim() === '$$') {
                        if (inMathBlock) {
                            const mathContent = mathBuffer.join('\n');
                            const isChem = mathContent.trim().startsWith('\\ce{');
                            const val = isChem ? mathContent.trim().slice(4, -1) : mathContent.trim();
                            
                            const div = document.createElement('div'); 
                            div.className='block-container'; 
                            div.contentEditable="false";
                            const mf = new MathfieldElement(); 
                            mf.value = val; 
                            mf.mathVirtualKeyboardPolicy="manual"; 
                            mf.classList.add(isChem ? 'chem-field' : 'math-field'); 
                            if(isChem) mf.setAttribute('letter-shape-style','upright');
                            
                            div.appendChild(mf); 
                            editor.appendChild(div); 
                            editor.appendChild(document.createElement('br'));
                            
                            inMathBlock = false; mathBuffer = [];
                        } else {
                            if(inList) { inList = false; listContainer = null; }
                            inMathBlock = true;
                        }
                        continue;
                    }
                    if (inMathBlock) { mathBuffer.push(line); continue; }

                    // --- 3. Markschemes ---
                    if (line.trim() === '<details>') { inMarkscheme = true; if(inList){inList=false; listContainer=null;} continue; }
                    if (line.trim() === '</details>') { 
                        processMarkscheme(markschemeBuffer);
                        inMarkscheme = false; markschemeBuffer = []; continue; 
                    }
                    if (inMarkscheme) { markschemeBuffer.push(line); continue; }

                    // --- 4. Lists (UL/OL) ---
                    const ulMatch = line.match(/^(\*|-)\s+(.*)/);
                    const olMatch = line.match(/^(\d+)\.\s+(.*)/);

                    if (ulMatch || olMatch) {
                        const type = ulMatch ? 'ul' : 'ol';
                        const content = ulMatch ? ulMatch[2] : olMatch[2];

                        if (!inList || currentListType !== type) {
                            listContainer = document.createElement(type);
                            editor.appendChild(listContainer);
                            currentListType = type;
                            inList = true;
                        }
                        const li = document.createElement('li');
                        processTextLine(content, li);
                        listContainer.appendChild(li);
                        continue;
                    } else {
                        inList = false; 
                        listContainer = null;
                    }

                    // --- 5. Regular Text / Quotes / Headers ---
                    processTextLine(line);
                }
            };
            reader.readAsText(input.files[0]);
            input.value = ''; 
        }

        async function processCodeBlock(type, code) {
            const p = document.createElement('p'); p.innerHTML='<br>';
            if (type === 'mermaid') {
                const w = document.createElement('div'); w.className='visual-block-wrapper mermaid-wrapper mermaid'; w.contentEditable="false"; w.dataset.source=code; w.innerHTML=code;
                w.dataset.state = JSON.stringify({nodes:[], edges:[]}); 
                editor.appendChild(w); editor.appendChild(p); await mermaid.run({nodes:[w]});
            } 
            else if (type === 'chart') {
                const config = JSON.parse(code);
                const data = config.data;
                const points = data.labels.map((l,i) => ({ label:l, value: data.datasets[0].data[i] }));
                const state = { type: config.type, title: config.options.plugins.title.text, label: data.datasets[0].label, points: points };
                const w = document.createElement('div'); w.className='visual-block-wrapper chart-wrapper'; w.contentEditable="false"; w.dataset.state=JSON.stringify(state); w.dataset.export=code;
                const cv = document.createElement('canvas'); cv.style.maxHeight="400px"; w.appendChild(cv);
                editor.appendChild(w); editor.appendChild(p); new Chart(cv, config);
            }
            else if (type === 'desmos') {
                const lines = code.split('\n'); let config = {}, exprs = [];
                lines.forEach(l => { if(l.startsWith('//config:')) { try { config = JSON.parse(l.replace('//config:', '')); } catch(e){} } else if(l.trim()) exprs.push(l.trim()); });
                const state = { config: config, expressions: exprs };
                const w = document.createElement('div'); w.className='visual-block-wrapper desmos-wrapper'; w.contentEditable="false"; w.dataset.state=JSON.stringify(state);
                const img = document.createElement('img'); img.src = ""; img.style.width='100%'; img.style.borderRadius='8px'; w.appendChild(img);
                editor.appendChild(w); editor.appendChild(p);
                const tempCalc = Desmos.GraphingCalculator(document.getElementById('tempCalculator'), {expressions:false});
                if(config.bounds) tempCalc.setMathBounds({left:config.bounds.x[0], right:config.bounds.x[1], bottom:config.bounds.y[0], top:config.bounds.y[1]});
                tempCalc.setExpressions(exprs.map(e=>({latex:e})));
                img.src = tempCalc.screenshot({width:600, height:400, targetPixelRatio:2});
                tempCalc.destroy();
            } else {
                // Regular Code Block - Use new wrapper logic
                const wrapper = document.createElement('div');
                wrapper.className = "code-block-wrapper";
                wrapper.contentEditable = "false";
                const pre = document.createElement('pre');
                pre.contentEditable = "true";
                pre.innerText = code;
                wrapper.appendChild(pre);
                editor.appendChild(wrapper);
                editor.appendChild(p);
            }
        }

        function processMarkscheme(lines) {
            let title = "Markscheme";
            let contentLines = [];
            lines.forEach(l => {
                if (l.trim().startsWith('<summary>')) title = l.replace(/<\/?summary>/g, '').trim();
                else if (l.trim() !== '') contentLines.push(l);
            });
            const d = document.createElement('details'); d.className='markscheme'; d.open=true; d.contentEditable="false";
            const sum = document.createElement('summary');
            const tSpan = document.createElement('span'); tSpan.className='summary-title'; tSpan.contentEditable="true"; tSpan.innerText = title;
            sum.appendChild(tSpan);
            const content = document.createElement('div'); content.className='markscheme-content'; content.contentEditable="true";
            d.appendChild(sum); d.appendChild(content);
            editor.appendChild(d);
            editor.appendChild(document.createElement('br'));
            contentLines.forEach(line => processTextLine(line, content));
        }

        function processTextLine(line, parent = editor) {
            if (!line.trim()) return;

            // FIX: Handle escaped periods (un-escape them)
            line = line.replace(/\\\./g, '.');
            
            // Headers
            if (line.startsWith('# ')) { const h=document.createElement('h1'); h.innerText=line.slice(2); parent.appendChild(h); return; }
            if (line.startsWith('## ')) { const h=document.createElement('h2'); h.innerText=line.slice(3); parent.appendChild(h); return; }
            if (line.startsWith('### ')) { const h=document.createElement('h3'); h.innerText=line.slice(4); parent.appendChild(h); return; }
            
            // Blockquotes - Use new wrapper logic
            if (line.startsWith('> ')) {
                const wrapper = document.createElement('div');
                wrapper.className = "quote-wrapper";
                wrapper.contentEditable = "false";
                const bq = document.createElement('blockquote');
                bq.contentEditable = "true";
                bq.innerText = line.slice(2);
                wrapper.appendChild(bq);
                parent.appendChild(wrapper);
                return;
            }

            // Images
            const imgMatch = line.match(/!\[.*\]\((.*)\)/);
            if (imgMatch) { const img = document.createElement('img'); img.src=imgMatch[1]; parent.appendChild(img); parent.appendChild(document.createElement('br')); return; }
            
            // Block Math (Single Line fallback)
            if (line.startsWith('$$') && line.endsWith('$$')) {
                const latex = line.slice(2, -2).trim(); const isChem = latex.startsWith('\\ce{'); const val = isChem ? latex.slice(4, -1) : latex;
                const div = document.createElement('div'); div.className='block-container'; div.contentEditable="false";
                const mf = new MathfieldElement(); mf.value=val; mf.mathVirtualKeyboardPolicy="manual"; mf.classList.add(isChem?'chem-field':'math-field'); if(isChem) mf.setAttribute('letter-shape-style','upright');
                div.appendChild(mf); parent.appendChild(div); parent.appendChild(document.createElement('br')); return;
            }

            // --- INLINE PARSING ---
            const p = (parent.tagName === 'LI') ? parent : document.createElement('p');
            
            // Regex to split by $...$ OR `...`
            let temp = line.replace(/\\\\/g, "___BS___").replace(/\\\*/g, "___AST___").replace(/\\_/g, "___US___");

            const parts = temp.split(/(`[^`]+`|\$[^$]+\$)/g);
            
            parts.forEach(part => {
                if (part.startsWith('$') && part.endsWith('$')) {
                    // Math
                    const latex = part.slice(1, -1).replace(/___BS___/g, "\\").replace(/___AST___/g, "*").replace(/___US___/g, "_");
                    const isChem = latex.startsWith('\\ce{');
                    const val = isChem ? latex.slice(4, -1) : latex;
                    const sp = document.createElement('span'); sp.className='math-wrapper'; sp.contentEditable="false";
                    const mf = new MathfieldElement(); mf.value=val; mf.mathVirtualKeyboardPolicy="manual"; mf.classList.add(isChem?'chem-field':'math-field'); if(isChem) mf.setAttribute('letter-shape-style','upright');
                    sp.appendChild(mf); p.appendChild(document.createTextNode('\u200B')); p.appendChild(sp); p.appendChild(document.createTextNode('\u200B'));
                } 
                else if (part.startsWith('`') && part.endsWith('`')) {
                    // Inline Code
                    const codeText = part.slice(1, -1).replace(/___BS___/g, "\\").replace(/___AST___/g, "*").replace(/___US___/g, "_");
                    const wrapper = document.createElement('span'); wrapper.className = 'code-wrapper'; wrapper.contentEditable = "false";
                    const codeSpan = document.createElement('span'); codeSpan.className = 'inline-code'; codeSpan.contentEditable = "true"; codeSpan.innerText = codeText;
                    wrapper.appendChild(codeSpan);
                    p.appendChild(document.createTextNode('\u200B')); p.appendChild(wrapper); p.appendChild(document.createTextNode('\u200B'));
                }
                else {
                    // Regular Text
                    let html = part;
                    html = html.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
                    html = html.replace(/\*(.*?)\*/g, "<i>$1</i>");
                    html = html.replace(/___BS___/g, "\\").replace(/___AST___/g, "*").replace(/___US___/g, "_");
                    const span = document.createElement('span');
                    span.innerHTML = html;
                    p.appendChild(span);
                }
            });

            if (parent.tagName !== 'LI') parent.appendChild(p);
        }

        function parseToMarkdown(element) {
            let md = "";
            element.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) md += node.textContent.replace(/\u200B/g, '').replace(/([\\*_{}[\]()#+\-.!])/g, '\\$1');
                else if (node.nodeType === Node.ELEMENT_NODE) {
                    const tag = node.tagName.toLowerCase(), style = window.getComputedStyle(node);
                    let prefix = "", suffix = "";
                    
                    if (tag === 'b' || tag === 'strong' || parseInt(style.fontWeight) > 600) { prefix += "**"; suffix = "**" + suffix; }
                    if (tag === 'i' || tag === 'em' || style.fontStyle === 'italic') { prefix += "*"; suffix = "*" + suffix; }
                    
                    // Headers
                    if (tag === 'h1') md += `\n# ${node.textContent}\n`;
                    else if (tag === 'h2') md += `\n## ${node.textContent}\n`;
                    else if (tag === 'h3') md += `\n### ${node.textContent}\n`;
                    
                    // Lists
                    else if (tag === 'ul') { md += "\n"; node.childNodes.forEach(li => { md += `* ${parseToMarkdown(li).trim()}\n`; }); md += "\n"; }
                    else if (tag === 'ol') { md += "\n"; let idx=1; node.childNodes.forEach(li => { md += `${idx}. ${parseToMarkdown(li).trim()}\n`; idx++; }); md += "\n"; }
                    
                    // Quotes (Wrapper)
                    else if (node.classList.contains('quote-wrapper')) md += `\n> ${node.innerText.trim()}\n`;
                    
                    // Code Block (Wrapper)
                    else if (node.classList.contains('code-block-wrapper')) md += `\n\`\`\`\n${node.innerText}\n\`\`\`\n`;

                    // Inline Code (Wrapper)
                    else if (node.classList.contains('code-wrapper')) md += " `" + node.innerText + "` ";

                    // Special Visual Blocks
                    else if (tag === 'img' && !node.closest('.visual-block-wrapper')) md += `\n![Image](${node.src})\n`;
                    else if (node.classList.contains('mermaid-wrapper')) md += `\n\`\`\`mermaid\n${node.dataset.source}\n\`\`\`\n`;
                    else if (node.classList.contains('chart-wrapper')) md += `\n\`\`\`chart\n${node.dataset.export}\n\`\`\`\n`;
                    else if (node.classList.contains('desmos-wrapper')) { const s = JSON.parse(node.dataset.state); md += `\n\`\`\`desmos\n//config: ${JSON.stringify(s.config)}\n${s.expressions.join('\n')}\n\`\`\`\n`; }
                    
                    // Math
                    else if (tag === 'math-field') {
                        const l = node.value, isC = node.classList.contains('chem-field'), isB = node.parentElement.classList.contains('block-container'), c = isC ? `\\ce{${l}}` : l;
                        md += isB ? `\n$$\n${c}\n$$\n` : `$${c}$`;
                    }
                    else if (node.classList.contains('math-wrapper')) md += parseToMarkdown(node);
                    
                    // Details
                    else if (tag === 'details') md += `\n<details>\n<summary>${node.querySelector('.summary-title').innerText}</summary>\n\n${parseToMarkdown(node.querySelector('.markscheme-content'))}\n</details>\n`;
                    
                    // Containers
                    else if (tag === 'p' || tag === 'div') { if (node.classList.contains('block-container')) md += parseToMarkdown(node); else md += `\n${parseToMarkdown(node)}\n`; }
                    else if (tag === 'br') md += "\n";
                    else if (tag === 'li') md += parseToMarkdown(node); 
                    
                    // Recursion for basic spans
                    else md += prefix + parseToMarkdown(node) + suffix;
                }
            });
            return md;
        }
    </script>
</body>
</html>
