<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVYSTUDY Editor</title>
    
    <!-- MathLive Library -->
    <script src="https://unpkg.com/mathlive"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Mermaid JS (Flowcharts) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <!-- Chart.js (Charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Desmos API -->
    <script src="https://www.desmos.com/api/v1.9/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --blur: blur(12px);
            
            --primary: #007AFF; 
            --primary-glow: rgba(0, 122, 255, 0.3);
            --chem: #34C759; 
            --danger: #FF3B30; 
            --text: #1d1d1f;
            --bg-app: #f5f5f7;
            
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            background-color: var(--bg-app);
            background-image: radial-gradient(circle at 50% -20%, #e0e7ff 0%, #f5f5f7 40%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: scroll; 
        }

        /* --- Global Keyboard Tweaks --- */
        math-virtual-keyboard {
            --keyboard-padding-bottom: 50px;
            --keyboard-zindex: 3000;
        }
        
        .action.warning { color: var(--danger) !important; }
        math-field.chem-field { --math-font-style: normal; }

        /* --- Toolbar --- */
        .toolbar-container {
            position: sticky;
            top: 20px;
            z-index: 1000;
            margin-bottom: 10px;
            margin-top: 20px;
            width: fit-content;
        }

        .toolbar {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            padding: 10px 14px;
            border-radius: 50px;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            display: flex;
            gap: 6px;
            align-items: center;
            user-select: none;
            transition: var(--transition);
        }

        .toolbar:hover {
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
            transform: translateY(-2px);
        }

        .tool-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            color: #555;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
        }
        
        .tool-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
            color: var(--text);
            transform: scale(1.1);
        }

        .tool-btn:active { transform: scale(0.95); }

        .tool-btn.active-state {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-math:hover { color: var(--primary); }
        .btn-chem:hover { color: var(--chem); }

        .tool-btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            color: white;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 4000;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }

        @keyframes fadeIn { to { opacity: 1; transform: translateX(-50%) translateY(-5px); } }
        .divider { width: 1px; height: 24px; background: rgba(0,0,0,0.1); margin: 0 6px; }

        /* --- Insert Menu Dropdown (Hoverable) --- */
        .insert-menu-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            /* Extra padding at bottom creates a bridge for the mouse so menu doesn't close */
            padding-bottom: 20px; 
            margin-bottom: -20px;
        }
        
        .insert-options {
            position: absolute;
            top: 100%; /* Position right below the wrapper */
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            padding: 8px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: none;
        }

        /* Show menu on hover */
        .insert-menu-wrapper:hover .insert-options, .insert-menu-wrapper.active .insert-options {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        /* --- Dropdown for Styles --- */
        .custom-select-wrapper { position: relative; min-width: 130px; }
        .custom-select-trigger {
            padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.5);
            border: 1px solid transparent; cursor: pointer; font-size: 0.9rem;
            font-weight: 500; display: flex; justify-content: space-between; align-items: center;
            transition: var(--transition);
        }
        .custom-select-trigger:hover { background: rgba(255,255,255,0.8); }
        .custom-select-trigger::after { content: '‚ñº'; font-size: 0.6em; margin-left: 10px; color: #888; }
        .custom-options {
            position: absolute; top: 120%; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(15px);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2); overflow: hidden; opacity: 0; visibility: hidden;
            transform: translateY(-10px); transition: var(--transition); z-index: 2000;
        }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 10px 16px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .custom-option:hover { background: var(--primary); color: white; }
        .custom-option.selected { background: rgba(0,0,0,0.05); font-weight: 600; }

        /* --- Editor --- */
        #docTitle {
            background: transparent; border: none; font-size: 2.5rem; font-weight: 700;
            color: var(--text); text-align: center; width: 100%; max-width: 850px;
            margin: 10px 0 20px 0; padding: 10px; outline: none; opacity: 0.5;
            transition: var(--transition); font-family: inherit;
        }
        #docTitle:hover, #docTitle:focus { opacity: 1; }
        #docTitle::placeholder { color: #aaa; font-weight: 500; }

        #editor {
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px);
            width: 100%; max-width: 850px; min-height: 1000px; border-radius: 4px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 80px; box-sizing: border-box;
            outline: none; font-size: 16px; line-height: 1.7; margin-bottom: 50px;
            transition: box-shadow 0.3s;
        }
        #editor:focus { box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        #editor h1 { font-size: 2.2em; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 0.3em; }
        #editor h2 { font-size: 1.6em; color: #333; margin-top: 1.5em; }
        
        /* Images & Math */
        #editor img {
            max-width: 100%; border-radius: 8px; cursor: move;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: 0.2s;
        }
        math-field {
            background: rgba(0,0,0,0.04); border-radius: 6px; padding: 2px 8px;
            transition: var(--transition); border: 1px solid transparent; min-width: 30px;
        }
        math-field:focus-within {
            background: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
            transform: scale(1.02); z-index: 10;
        }
        math-field.chem-field { background: rgba(52, 199, 89, 0.1); color: #0c501e; font-style: normal !important; }
        math-field.chem-field:focus-within { box-shadow: 0 4px 12px rgba(52, 199, 89, 0.25); }
        
        .math-wrapper { display: inline-block; vertical-align: middle; margin: 0 2px; }
        .block-container math-field {
            padding: 15px 25px; font-size: 1.3em; background: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px; display: block;
        }

        /* --- Visual Blocks (Mermaid & Chart.js & Desmos) --- */
        .visual-block-wrapper {
            display: block;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            max-width: 600px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            position: relative;
        }
        .visual-block-wrapper:hover {
            background: rgba(0, 122, 255, 0.02);
            border: 1px dashed rgba(0, 122, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .visual-block-wrapper::after {
            content: 'Double-click to edit';
            display: block;
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 10px;
            text-align: center;
            opacity: 0;
            transition: 0.2s;
        }
        .visual-block-wrapper:hover::after { opacity: 1; }
        
        .mermaid svg, canvas, .visual-block-wrapper img { max-width: 100%; height: auto !important; display: block; }
        
        .desmos-wrapper img {
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* --- Markscheme --- */
        details.markscheme {
            background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden; margin: 20px 0; border: 1px solid rgba(0,0,0,0.05);
        }
        details.markscheme summary {
            background: rgba(245, 245, 247, 0.8); padding: 12px 20px; cursor: pointer;
            font-weight: 600; transition: 0.2s;
        }
        details.markscheme summary:hover { background: #f0f0f2; }
        .markscheme-content { padding: 20px; }

        .btn-download {
            background: var(--primary); color: white; font-weight: 600; font-size: 0.9rem;
            padding: 8px 20px; border-radius: 20px;
        }
        .btn-download:hover { box-shadow: 0 4px 15px var(--primary-glow); transform: translateY(-1px); }

        /* --- Common Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); padding: 30px;
            border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.4); display: flex; flex-direction: column; gap: 15px;
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal h3 { margin: 0; font-size: 1.2rem; text-align: center; color: #333; }

        /* --- Large Builder Modal --- */
        .modal.large-modal { width: 95vw; height: 90vh; flex-direction: row; padding: 0; overflow: hidden; }
        .modal.desmos-modal { flex-direction: column; padding: 20px; }

        .builder-panel {
            width: 30%; min-width: 320px; background: rgba(250, 250, 252, 0.8);
            border-right: 1px solid rgba(0,0,0,0.1); padding: 20px; display: flex;
            flex-direction: column; gap: 15px; overflow-y: auto;
        }
        .preview-panel {
            width: 70%; padding: 20px; background: white; display: flex;
            align-items: center; justify-content: center; position: relative; overflow: auto;
        }

        #desmosCalculator { width: 100%; height: 100%; border-radius: 12px; overflow: hidden; border: 1px solid #ccc; }

        /* Builder UI Controls */
        .builder-section {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05);
        }
        .builder-header {
            font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .builder-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .builder-input, .builder-select {
            padding: 8px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; flex: 1;
        }
        .btn-icon {
            background: #eee; border: none; width: 32px; height: 32px; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555;
            transition: 0.2s;
        }
        .btn-icon:hover { background: #e0e0e0; color: black; }
        .btn-icon.delete:hover { background: #ffebeb; color: var(--danger); }
        .btn-add-item {
            width: 100%; padding: 8px; border: 1px dashed #ccc; background: transparent;
            border-radius: 8px; color: #666; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        }
        .btn-add-item:hover { border-color: var(--primary); color: var(--primary); background: rgba(0,122,255,0.05); }

        .chart-actions { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }

        .glass-input {
            padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.5); font-size: 1rem; outline: none; transition: 0.2s;
        }
        .glass-input:focus { background: white; border-color: var(--primary); }
        .or-divider { text-align: center; color: #888; font-size: 0.85rem; font-weight: 500; }
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .btn-file-choice {
            border: 2px dashed rgba(0,0,0,0.1); border-radius: 12px; background: rgba(255,255,255,0.4);
            color: #555; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s;
            font-weight: 500; display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .btn-file-choice:hover { border-color: var(--primary); color: var(--primary); background: rgba(0,122,255,0.05); }
        #imgFileInput { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .modal-actions { display: flex; justify-content: space-between; margin-top: 10px; }
        .btn-glass { padding: 10px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; }
        .btn-glass-cancel { background: rgba(0,0,0,0.05); color: #555; }
        .btn-glass-cancel:hover { background: rgba(0,0,0,0.1); }
        .btn-glass-insert { background: var(--primary); color: white; opacity: 0.5; pointer-events: none; }
        .btn-glass-insert.active { opacity: 1; pointer-events: auto; box-shadow: 0 4px 15px var(--primary-glow); }

        .chart-container-box { width: 100%; max-width: 600px; height: 400px; display: flex; justify-content: center; }

    </style>
</head>
<body>

    <div class="toolbar-container">
        <div class="toolbar">
            <!-- Styles Dropdown -->
            <div class="custom-select-wrapper" id="styleDropdown">
                <div class="custom-select-trigger" onclick="toggleDropdown()">Normal</div>
                <div class="custom-options">
                    <div class="custom-option selected" onclick="selectStyle('p', 'Normal')">Normal</div>
                    <div class="custom-option" onclick="selectStyle('h1', 'Heading 1')">Heading 1</div>
                    <div class="custom-option" onclick="selectStyle('h2', 'Heading 2')">Heading 2</div>
                    <div class="custom-option" onclick="selectStyle('h3', 'Heading 3')">Heading 3</div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- Formatting -->
            <button class="tool-btn" id="btnBold" onclick="toggleFormat('bold')" title="Bold"><i class="ph ph-text-b"></i></button>
            <button class="tool-btn" id="btnItalic" onclick="toggleFormat('italic')" title="Italic"><i class="ph ph-text-italic"></i></button>
            <button class="tool-btn" id="btnUnderline" onclick="toggleFormat('underline')" title="Underline"><i class="ph ph-text-underline"></i></button>
            
            <div class="divider"></div>

            <!-- Math & Chem -->
            <button class="tool-btn btn-math" onclick="insertMath('inline')" title="Inline Math"><i class="ph ph-sigma"></i></button>
            <button class="tool-btn btn-math" onclick="insertMath('block')" title="Block Math"><i class="ph ph-sigma" style="font-weight:bold; border: 2px solid currentColor; border-radius: 4px; padding: 2px; font-size: 0.8rem;"></i></button>

            <div class="divider"></div>

            <button class="tool-btn btn-chem" onclick="insertChem('inline')" title="Inline Chem"><i class="ph ph-flask"></i></button>
            <button class="tool-btn btn-chem" onclick="insertChem('block')" title="Block Chem"><i class="ph ph-flask" style="font-weight:bold; border: 2px solid currentColor; border-radius: 4px; padding: 2px; font-size: 0.8rem;"></i></button>

            <div class="divider"></div>

            <!-- Insert Menu (Hoverable) -->
            <div class="insert-menu-wrapper">
                <button class="tool-btn" title="Insert..."><i class="ph ph-plus"></i></button>
                <div class="insert-options">
                    <button class="tool-btn" onclick="openImageModal()" title="Image"><i class="ph ph-image"></i></button>
                    <button class="tool-btn" onclick="openFlowchartModal()" title="Flowchart"><i class="ph ph-tree-structure"></i></button>
                    <button class="tool-btn" onclick="openChartJsModal()" title="Chart"><i class="ph ph-chart-bar"></i></button>
                    <button class="tool-btn" onclick="openDesmosModal()" title="Calculator"><i class="ph ph-calculator"></i></button>
                    <button class="tool-btn" onclick="insertMarkscheme()" title="Markscheme"><i class="ph ph-list-checks"></i></button>
                </div>
            </div>

            <div class="divider"></div>

            <button class="tool-btn btn-download" onclick="downloadMarkdown()">Download</button>
        </div>
    </div>

    <!-- Title Input -->
    <input type="text" id="docTitle" placeholder="Untitled Note" spellcheck="false" autocomplete="off">

    <!-- The Paper -->
    <div id="editor" contenteditable="true" spellcheck="false">
        <h1>Markdown Creator</h1>
        <p>Start typing here...</p>
    </div>

    <!-- Image Modal -->
    <div id="imgModal" class="modal-overlay">
        <div class="modal">
            <h3>Add Media</h3>
            <input type="text" class="glass-input" id="imgUrlInput" placeholder="Paste image URL here..." oninput="checkImgInput()">
            <div class="or-divider">OR</div>
            <div class="file-upload-wrapper">
                <div class="btn-file-choice">
                    <i class="ph ph-upload-simple"></i>
                    <span id="fileNameDisplay">Click to upload from device</span>
                </div>
                <input type="file" id="imgFileInput" accept="image/*" onchange="handleFileSelect()">
            </div>
            <div class="modal-actions">
                <button class="btn-glass btn-glass-cancel" onclick="closeImageModal()">Cancel</button>
                <button id="btnInsertImg" class="btn-glass btn-glass-insert" onclick="confirmInsertImage()">Insert Image</button>
            </div>
        </div>
    </div>

    <!-- Flowchart Builder Modal -->
    <div id="chartModal" class="modal-overlay">
        <div class="modal large-modal">
            <div class="builder-panel">
                <h3>Flowchart Builder</h3>
                <p style="font-size:0.8rem; color:#666;">Add nodes, then connect them.</p>
                <div class="builder-section">
                    <div class="builder-header">Nodes</div>
                    <div id="nodesList"></div>
                    <button class="btn-add-item" onclick="addChartNode()"><i class="ph ph-plus"></i> Add Node</button>
                </div>
                <div class="builder-section">
                    <div class="builder-header">Connections</div>
                    <div id="connectionsList"></div>
                    <button class="btn-add-item" onclick="addChartConnection()"><i class="ph ph-plus"></i> Add Connection</button>
                </div>
                <div style="flex:1"></div>
                <button class="btn-glass btn-glass-cancel" onclick="closeFlowchartModal()">Cancel</button>
            </div>
            <div class="preview-panel">
                <div id="chartPreview"></div>
                <div class="chart-actions">
                    <button class="btn-glass btn-glass-insert active" onclick="confirmInsertChart()">Insert Diagram</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js Builder Modal -->
    <div id="chartJsModal" class="modal-overlay">
        <div class="modal large-modal">
            <div class="builder-panel">
                <h3>Chart Builder</h3>
                <p style="font-size:0.8rem; color:#666;">Configure your chart data.</p>
                <div class="builder-section">
                    <div class="builder-header">Settings</div>
                    <div class="builder-row">
                        <select id="cjsType" class="builder-select" onchange="updateChartJsPreview()">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="pie">Pie Chart</option>
                            <option value="doughnut">Doughnut Chart</option>
                        </select>
                    </div>
                    <div class="builder-row">
                        <input type="text" id="cjsTitle" class="builder-input" placeholder="Chart Title" oninput="updateChartJsPreview()">
                    </div>
                    <div class="builder-row">
                        <input type="text" id="cjsDatasetLabel" class="builder-input" placeholder="Dataset Label (e.g. Sales)" value="Data" oninput="updateChartJsPreview()">
                    </div>
                </div>
                <div class="builder-section">
                    <div class="builder-header">Data Points (Label | Value)</div>
                    <div id="cjsDataList"></div>
                    <button class="btn-add-item" onclick="addChartJsPoint()"><i class="ph ph-plus"></i> Add Point</button>
                </div>
                <div style="flex:1"></div>
                <button class="btn-glass btn-glass-cancel" onclick="closeChartJsModal()">Cancel</button>
            </div>
            <div class="preview-panel">
                <div class="chart-container-box">
                    <canvas id="cjsPreviewCanvas"></canvas>
                </div>
                <div class="chart-actions">
                    <button class="btn-glass btn-glass-insert active" onclick="confirmInsertChartJs()">Insert Chart</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Desmos Modal -->
    <div id="desmosModal" class="modal-overlay">
        <div class="modal large-modal desmos-modal">
            <div style="flex:1; position:relative;">
                <div id="desmosCalculator"></div>
                <div class="chart-actions">
                    <button class="btn-glass btn-glass-cancel" style="background: white;" onclick="closeDesmosModal()">Cancel</button>
                    <button class="btn-glass btn-glass-insert active" onclick="confirmInsertDesmos()">Insert Graph</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log(`       
                ============================================================
                ‚ö†Ô∏è DESMOS API DISCLAIMER ‚Äì REQUIRED NOTICE ‚ö†Ô∏è
                ============================================================

                This project references or utilizes elements of the Desmos Graphing Calculator
                or its API. Please be aware of the following critical usage restrictions:

                1. Desmos does NOT offer public or open access to their API.
                Any integration beyond their public graphing calculator embed
                must be explicitly approved through Desmos‚Äôs official Partnership Program.

                2. API keys and advanced features (e.g., programmatic graph creation,
                data syncing, deep integrations) require PRIOR authorization.

                3. Unauthorized use of the Desmos API‚Äîincluding accessing endpoints
                without permission, reverse engineering, scraping, or automated access‚Äî
                is strictly forbidden and may violate Desmos‚Äôs Terms of Service.

                4. If you wish to use the Desmos API legally and safely, you MUST:
                - Apply at https://www.desmos.com/partners
                - Receive approval and credentials from Desmos, Inc.
                - Follow all relevant documentation and branding guidelines

                5. This project is NOT affiliated with or endorsed by Desmos, Inc.
                All trademarks and services belong to their respective owners.

                Failure to comply with these terms can result in:
                - API access revocation
                - Legal action
                - Application malfunction or incompatibility
                - User data loss or privacy violations

                üîó Official API access: https://www.desmos.com/partners
                üîó Terms of Service: https://www.desmos.com/terms
                üîó Privacy Policy: https://www.desmos.com/privacy

                DO NOT use the Desmos API in production or distributed applications
                without explicit permission from Desmos.

                ============================================================


        `);
        // --- 1. Constants & Init ---
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'neutral',
            flowchart: { htmlLabels: true, curve: 'basis' }
        });

        const CHEM_LAYOUT = {
            label: "Chem",
            tooltip: "Chemistry",
            rows: [
                [
                    { label: "1", key: "1" }, { label: "2", key: "2" }, { label: "3", key: "3" }, { label: "4", key: "4" }, { label: "5", key: "5" },
                    { label: "+", key: "+" }, { label: "‚àí", key: "-" }, { label: "=", key: "=" },
                    { label: "‚ü∂", latex: "\\longrightarrow" }, 
                    { label: "‚áå", latex: "\\rightleftharpoons" }
                ],
                [
                    { label: "6", key: "6" }, { label: "7", key: "7" }, { label: "8", key: "8" }, { label: "9", key: "9" }, { label: "0", key: "0" },
                    { label: "(", key: "(" }, { label: ")", key: ")" },
                    { label: "<span>‚óª</span><sup><span>‚óª</span></sup>", latex: "^{#?}" },
                    { label: "<span>‚óª</span><sub><span>‚óª</span></sub>", latex: "_{#?}" },
                    { label: "Sup/Sub", latex: "_{#?}^{#?}" }
                ],
                [
                    { label: "e‚Åª", latex: "e^-" },
                    { label: "H‚Å∫", latex: "H^+" },
                    { label: "Œî", latex: "\\Delta" },
                    { label: "mol", latex: "\\text{mol}" },
                    { label: "(s)", latex: "_{(s)}" },
                    { label: "(l)", latex: "_{(l)}" },
                    { label: "(g)", latex: "_{(g)}" },
                    { label: "(aq)", latex: "_{(aq)}" },
                    { class: "action", label: "‚å´", command: ["performWithFeedback", "deleteBackward"] },
                    { class: "action warning", label: "üóë", command: "deleteEquation" }
                ]
            ]
        };

        const editor = document.getElementById('editor');
        const imgModal = document.getElementById('imgModal');
        const imgUrlInput = document.getElementById('imgUrlInput');
        const imgFileInput = document.getElementById('imgFileInput');
        const btnInsertImg = document.getElementById('btnInsertImg');
        const docTitle = document.getElementById('docTitle');
        
        let savedRange = null;

        // --- Math & Keyboard ---
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof MathfieldElement !== 'undefined') {
                MathfieldElement.commands.deleteEquation = (mf) => {
                    const parent = mf.parentElement;
                    if (parent) {
                        setTimeout(() => {
                            if(parent.classList.contains('math-wrapper')) parent.remove();
                            else if(parent.classList.contains('block-container')) parent.remove();
                            else mf.remove();
                            editor.focus();
                        }, 10);
                    }
                    return true;
                };
            }
        });

        document.addEventListener('focusin', (e) => {
            const target = e.target;
            if (target.tagName && target.tagName.toLowerCase() === 'math-field') {
                updateKeyboardLayout(target);
                if (window.mathVirtualKeyboard) window.mathVirtualKeyboard.show();
            }
        });
        document.addEventListener('focusout', (e) => {
            const target = e.target;
            if (target.tagName && target.tagName.toLowerCase() === 'math-field') {
                setTimeout(() => {
                    const newFocus = document.activeElement;
                    if (!newFocus || newFocus.tagName.toLowerCase() !== 'math-field') {
                        if (window.mathVirtualKeyboard) window.mathVirtualKeyboard.hide();
                    }
                }, 50);
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (window.mathVirtualKeyboard) window.mathVirtualKeyboard.hide();
                closeImageModal();
                closeFlowchartModal();
                closeChartJsModal();
                closeDesmosModal();
                // Close menu if open (via removing focus, CSS hover handles rest)
                document.activeElement.blur();
            }
        });

        function updateKeyboardLayout(target) {
            if (!window.mathVirtualKeyboard) return;
            if (target.classList.contains('chem-field')) window.mathVirtualKeyboard.layouts = [CHEM_LAYOUT];
            else window.mathVirtualKeyboard.layouts = "default";
        }

        // --- Editor Functions ---
        const dropdownWrapper = document.getElementById('styleDropdown');
        const dropdownTrigger = dropdownWrapper.querySelector('.custom-select-trigger');
        const options = dropdownWrapper.querySelectorAll('.custom-option');

        function toggleDropdown() { dropdownWrapper.classList.toggle('open'); }
        function selectStyle(tag, label) {
            document.execCommand('formatBlock', false, tag);
            dropdownTrigger.childNodes[0].nodeValue = label; 
            options.forEach(opt => opt.classList.remove('selected'));
            event.target.classList.add('selected');
            dropdownWrapper.classList.remove('open');
            editor.focus();
        }
        window.addEventListener('click', (e) => {
            if (!dropdownWrapper.contains(e.target)) dropdownWrapper.classList.remove('open');
        });
        function toggleFormat(cmd) { document.execCommand(cmd, false, null); editor.focus(); checkFormatState(); }
        function checkFormatState() {
            const isBold = document.queryCommandState('bold');
            const isItalic = document.queryCommandState('italic');
            const isUnderline = document.queryCommandState('underline');
            document.getElementById('btnBold').classList.toggle('active-state', isBold);
            document.getElementById('btnItalic').classList.toggle('active-state', isItalic);
            document.getElementById('btnUnderline').classList.toggle('active-state', isUnderline);
        }
        document.addEventListener('selectionchange', () => {
             if (document.activeElement === editor || editor.contains(document.activeElement)) checkFormatState();
        });
        document.execCommand('defaultParagraphSeparator', false, 'p');

        function createField(type) {
            const mf = new MathfieldElement();
            mf.mathVirtualKeyboardPolicy = "manual"; 
            mf.addEventListener('focus-out', (ev) => {
                if (ev.detail.direction === 'forward') {
                    const wrapper = mf.parentElement;
                    if (wrapper && wrapper.classList.contains('math-wrapper') && wrapper.nextSibling) {
                        const range = document.createRange();
                        range.setStart(wrapper.nextSibling, 0); 
                        range.collapse(true);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }
            });
            if (type === 'chem') {
                mf.classList.add('chem-field');
                mf.setAttribute('letter-shape-style', 'upright'); 
            } else {
                mf.classList.add('math-field');
            }
            return mf;
        }

        function insertMath(mode) { insertField('math', mode); }
        function insertChem(mode) { insertField('chem', mode); }
        function insertField(type, mode) {
            const mf = createField(type);
            mf.value = type === 'chem' ? "" : "x";
            
            if (mode === 'inline') {
                const wrapper = document.createElement('span');
                wrapper.className = 'math-wrapper';
                wrapper.contentEditable = "false";
                wrapper.appendChild(mf);
                
                // --- UPDATE: Add ZWSP BEFORE AND AFTER for easier deletion ---
                const zwspBefore = document.createTextNode('\u200B'); 
                const zwspAfter = document.createTextNode('\u200B');
                
                const sel = window.getSelection();
                if (sel.rangeCount) {
                    const range = sel.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(zwspAfter);
                    range.insertNode(wrapper);
                    range.insertNode(zwspBefore);
                    
                    // Move cursor after the last ZWSP
                    range.setStartAfter(zwspAfter);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                    
                    setTimeout(() => { mf.focus(); }, 50);
                }
            } else {
                const container = document.createElement('div');
                container.className = 'block-container';
                container.contentEditable = "false";
                container.appendChild(mf);
                insertNodeAtCursor(container);
                const p = document.createElement('p');
                p.innerHTML = "<br>";
                container.after(p);
                setTimeout(() => { mf.focus(); }, 50);
            }
        }

        function saveSelection() {
            const sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                if (editor.contains(sel.anchorNode)) savedRange = sel.getRangeAt(0);
                else savedRange = null;
            }
        }
        function restoreSelection() {
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            } else {
                editor.focus();
            }
        }
        function insertNodeAtCursor(node) {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(node);
            range.setStartAfter(node);
            range.setEndAfter(node);
            sel.removeAllRanges();
            sel.addRange(range);
        }

        // --- MERMAID FLOWCHART LOGIC ---
        const chartModal = document.getElementById('chartModal');
        let chartNodes = [];
        let chartEdges = [];
        let editingChartElement = null;

        function openFlowchartModal(existingData = null) {
            saveSelection();
            chartModal.classList.add('active');
            if (existingData) {
                chartNodes = existingData.nodes || [];
                chartEdges = existingData.edges || [];
            } else {
                chartNodes = [{ id: 'A', text: 'Start', shape: 'rect' }, { id: 'B', text: 'End', shape: 'rect' }];
                chartEdges = [{ from: 'A', to: 'B', text: '' }];
            }
            renderBuilderUI();
            updateChartPreview();
        }

        function closeFlowchartModal() {
            chartModal.classList.remove('active');
            editingChartElement = null;
        }

        function renderBuilderUI() {
            const nodeList = document.getElementById('nodesList');
            const edgeList = document.getElementById('connectionsList');
            nodeList.innerHTML = ''; edgeList.innerHTML = '';

            chartNodes.forEach((node, index) => {
                const row = document.createElement('div');
                row.className = 'builder-row';
                row.innerHTML = `
                    <select class="builder-select" style="max-width:80px" onchange="updateNodeShape(${index}, this.value)">
                        <option value="rect" ${node.shape === 'rect' ? 'selected' : ''}>Square</option>
                        <option value="round" ${node.shape === 'round' ? 'selected' : ''}>Round</option>
                        <option value="diamond" ${node.shape === 'diamond' ? 'selected' : ''}>Decision</option>
                    </select>
                    <input type="text" class="builder-input" value="${node.text}" placeholder="Node Text" oninput="updateNodeText(${index}, this.value)">
                    <button class="btn-icon delete" onclick="removeNode(${index})"><i class="ph ph-trash"></i></button>
                `;
                nodeList.appendChild(row);
            });

            chartEdges.forEach((edge, index) => {
                const row = document.createElement('div');
                row.className = 'builder-row';
                let options = chartNodes.map(n => `<option value="${n.id}" ${n.id === edge.from ? 'selected' : ''}>${(n.text.substring(0,20))}</option>`).join('');
                let optionsTo = chartNodes.map(n => `<option value="${n.id}" ${n.id === edge.to ? 'selected' : ''}>${(n.text.substring(0,20))}</option>`).join('');
                
                row.innerHTML = `
                    <select class="builder-select" onchange="updateEdge(${index}, 'from', this.value)">${generateOptions(edge.from)}</select>
                    <i class="ph ph-arrow-right"></i>
                    <select class="builder-select" onchange="updateEdge(${index}, 'to', this.value)">${generateOptions(edge.to)}</select>
                    <input type="text" class="builder-input" value="${edge.text || ''}" placeholder="Label (Optional)" oninput="updateEdge(${index}, 'text', this.value)">
                    <button class="btn-icon delete" onclick="removeEdge(${index})"><i class="ph ph-trash"></i></button>
                `;
                edgeList.appendChild(row);
            });
        }
        function generateOptions(selectedId) {
            return chartNodes.map(n => `<option value="${n.id}" ${n.id === selectedId ? 'selected' : ''}>${(n.text.substring(0,20) + (n.text.length>20?'...':'')) || n.id}</option>`).join('');
        }
        function addChartNode() {
            chartNodes.push({ id: 'N' + Date.now().toString().slice(-4), text: 'New Node', shape: 'rect' });
            renderBuilderUI(); updateChartPreview();
        }
        function removeNode(index) {
            const nodeId = chartNodes[index].id;
            chartNodes.splice(index, 1);
            chartEdges = chartEdges.filter(e => e.from !== nodeId && e.to !== nodeId);
            renderBuilderUI(); updateChartPreview();
        }
        function updateNodeShape(index, value) { chartNodes[index].shape = value; updateChartPreview(); }
        function updateNodeText(index, value) { chartNodes[index].text = value; updateChartPreview(); }
        function addChartConnection() {
            if(chartNodes.length < 2) return;
            chartEdges.push({ from: chartNodes[0].id, to: chartNodes[1].id, text: '' });
            renderBuilderUI(); updateChartPreview();
        }
        function removeEdge(index) { chartEdges.splice(index, 1); renderBuilderUI(); updateChartPreview(); }
        function updateEdge(index, key, value) { chartEdges[index][key] = value; updateChartPreview(); }
        async function updateChartPreview() {
            const code = generateMermaidCode();
            const container = document.getElementById('chartPreview');
            container.innerHTML = `<div class="mermaid">${code}</div>`;
            try { await mermaid.run({ nodes: [container.querySelector('.mermaid')] }); } catch (e) {}
        }
        function generateMermaidCode() {
            let code = "graph TD\nclassDef default fill:#fff,stroke:#333,stroke-width:1px;\n";
            chartNodes.forEach(n => {
                let s = "[", e = "]"; if(n.shape==='round'){s="(";e=")";} if(n.shape==='diamond'){s="{";e="}";}
                code += `${n.id}${s}"${n.text.replace(/"/g, "'")}"${e}\n`;
            });
            chartEdges.forEach(e => { code += `${e.from} -->${e.text?`|"${e.text}"|`:''} ${e.to}\n`; });
            return code;
        }
        async function confirmInsertChart() {
            const code = generateMermaidCode();
            const dataState = JSON.stringify({ nodes: chartNodes, edges: chartEdges });
            if (editingChartElement) {
                editingChartElement.dataset.source = code;
                editingChartElement.dataset.state = dataState;
                editingChartElement.innerHTML = code;
                editingChartElement.removeAttribute('data-processed');
                await mermaid.run({ nodes: [editingChartElement] });
                closeFlowchartModal();
                return;
            }
            restoreSelection();
            const wrapper = document.createElement('div');
            wrapper.className = 'visual-block-wrapper mermaid-wrapper mermaid';
            wrapper.contentEditable = "false";
            wrapper.dataset.source = code;
            wrapper.dataset.state = dataState;
            wrapper.innerHTML = code;
            insertNodeAtCursor(wrapper);
            const p = document.createElement('p'); p.innerHTML = "<br>"; wrapper.after(p);
            await mermaid.run({ nodes: [wrapper] });
            closeFlowchartModal();
        }

        // --- CHART.JS BUILDER LOGIC ---
        const chartJsModal = document.getElementById('chartJsModal');
        const cjsPreviewCanvas = document.getElementById('cjsPreviewCanvas');
        let cjsInstance = null;
        let cjsData = { type: 'bar', title: '', label: 'Data', points: [] }; 
        let editingCjsElement = null;

        function openChartJsModal(existingData = null) {
            saveSelection();
            chartJsModal.classList.add('active');
            
            if (existingData) {
                cjsData = existingData;
            } else {
                cjsData = {
                    type: 'bar',
                    title: 'My Chart',
                    label: 'Dataset 1',
                    points: [{ label: 'Jan', value: 10 }, { label: 'Feb', value: 20 }]
                };
            }
            document.getElementById('cjsType').value = cjsData.type;
            document.getElementById('cjsTitle').value = cjsData.title;
            document.getElementById('cjsDatasetLabel').value = cjsData.label;
            
            renderChartJsBuilder();
            updateChartJsPreview();
        }

        function closeChartJsModal() {
            chartJsModal.classList.remove('active');
            editingCjsElement = null;
            if (cjsInstance) { cjsInstance.destroy(); cjsInstance = null; }
        }

        function renderChartJsBuilder() {
            const list = document.getElementById('cjsDataList');
            list.innerHTML = '';
            cjsData.points.forEach((point, index) => {
                const row = document.createElement('div');
                row.className = 'builder-row';
                row.innerHTML = `
                    <input type="text" class="builder-input" placeholder="Label" value="${point.label}" oninput="updateCjsPoint(${index}, 'label', this.value)">
                    <input type="number" class="builder-input" placeholder="Value" value="${point.value}" oninput="updateCjsPoint(${index}, 'value', this.value)">
                    <button class="btn-icon delete" onclick="removeCjsPoint(${index})"><i class="ph ph-trash"></i></button>
                `;
                list.appendChild(row);
            });
        }
        function addChartJsPoint() { cjsData.points.push({ label: 'New', value: 0 }); renderChartJsBuilder(); updateChartJsPreview(); }
        function removeCjsPoint(index) { cjsData.points.splice(index, 1); renderChartJsBuilder(); updateChartJsPreview(); }
        function updateCjsPoint(index, key, value) { cjsData.points[index][key] = (key === 'value') ? parseFloat(value) || 0 : value; updateChartJsPreview(); }
        function generateChartColors(count, type) {
            const colors = ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'];
            const borders = ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'];
            let bg = [], bd = [];
            if (type === 'line') return { bg: colors[1], bd: borders[1] };
            for(let i=0; i<count; i++) { bg.push(colors[i % colors.length]); bd.push(borders[i % borders.length]); }
            return { bg: bg, bd: bd };
        }
        function updateChartJsPreview() {
            cjsData.type = document.getElementById('cjsType').value;
            cjsData.title = document.getElementById('cjsTitle').value;
            cjsData.label = document.getElementById('cjsDatasetLabel').value;
            if (cjsInstance) cjsInstance.destroy();
            const labels = cjsData.points.map(p => p.label);
            const data = cjsData.points.map(p => p.value);
            const colors = generateChartColors(data.length, cjsData.type);
            const config = {
                type: cjsData.type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: cjsData.label,
                        data: data,
                        backgroundColor: colors.bg,
                        borderColor: colors.bd,
                        borderWidth: 1,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { title: { display: !!cjsData.title, text: cjsData.title }, legend: { display: (cjsData.type !== 'bar') } }
                }
            };
            cjsInstance = new Chart(cjsPreviewCanvas, config);
        }
        function confirmInsertChartJs() {
            const labels = cjsData.points.map(p => p.label);
            const data = cjsData.points.map(p => p.value);
            const colors = generateChartColors(data.length, cjsData.type);
            const finalConfig = {
                type: cjsData.type,
                data: { labels: labels, datasets: [{ label: cjsData.label, data: data, backgroundColor: colors.bg, borderColor: colors.bd, borderWidth: 1 }] },
                options: { plugins: { title: { display: !!cjsData.title, text: cjsData.title } } }
            };
            if (cjsData.type === 'line') { finalConfig.data.datasets[0].tension = 0.1; finalConfig.data.datasets[0].fill = false; }
            
            const stateJson = JSON.stringify(cjsData);
            const exportJson = JSON.stringify(finalConfig, null, 2);

            if (editingCjsElement) {
                editingCjsElement.dataset.state = stateJson;
                editingCjsElement.dataset.export = exportJson;
                const canvas = editingCjsElement.querySelector('canvas');
                const chartInst = Chart.getChart(canvas);
                if(chartInst) chartInst.destroy();
                new Chart(canvas, finalConfig);
                closeChartJsModal();
                return;
            }
            restoreSelection();
            const wrapper = document.createElement('div');
            wrapper.className = 'visual-block-wrapper chart-wrapper';
            wrapper.contentEditable = "false";
            wrapper.dataset.state = stateJson;
            wrapper.dataset.export = exportJson;
            const canvas = document.createElement('canvas');
            canvas.style.maxHeight = "400px";
            wrapper.appendChild(canvas);
            insertNodeAtCursor(wrapper);
            const p = document.createElement('p'); p.innerHTML = "<br>"; wrapper.after(p);
            new Chart(canvas, finalConfig);
            closeChartJsModal();
        }

        // --- DESMOS INTEGRATION (FIXED) ---
        const desmosModal = document.getElementById('desmosModal');
        let calculator = null;
        let editingDesmosElement = null;

        function openDesmosModal(existingState = null) {
            saveSelection();
            desmosModal.classList.add('active');
            
            // Fix: DESTROY any existing calculator first to prevent ghost events
            if (calculator) {
                calculator.destroy();
                calculator = null;
            }
            
            // Initialize New Calculator
            const elt = document.getElementById('desmosCalculator');
            calculator = Desmos.GraphingCalculator(elt, {
                settingsMenu: true,
                expressions: true
            });
            
            if (existingState) {
                if (existingState.config) {
                    const c = existingState.config;
                    if(c.bounds) calculator.setMathBounds({left: c.bounds.x[0], right: c.bounds.x[1], bottom: c.bounds.y[0], top: c.bounds.y[1]});
                    calculator.updateSettings({
                        showGrid: c.grid !== false, // default true
                        showXAxis: c.showXAxis !== false,
                        showYAxis: c.showYAxis !== false,
                        xAxisLabel: c.xAxisLabel || '',
                        yAxisLabel: c.yAxisLabel || ''
                    });
                }
                if (existingState.expressions) {
                    const exprs = existingState.expressions.map(latex => ({ latex: latex }));
                    calculator.setExpressions(exprs);
                }
            } else {
                calculator.setExpression({ id: 'graph1', latex: 'y=x^2' });
            }
        }

        function closeDesmosModal() {
            desmosModal.classList.remove('active');
            editingDesmosElement = null;
            // Fix: Destroy on close to stop all listeners
            if (calculator) {
                calculator.destroy();
                calculator = null;
            }
        }

        function confirmInsertDesmos() {
            // 1. Capture State for Edit/Export
            const state = calculator.getState();
            const bounds = calculator.graphpaperBounds.mathCoordinates;
            const settings = calculator.graphSettings;
            
            const expressions = state.expressions.list
                .filter(e => e.type === 'expression' && e.latex)
                .map(e => e.latex);

            const config = {
                bounds: { x: [bounds.left, bounds.right], y: [bounds.bottom, bounds.top] },
                grid: settings.showGrid,
                showXAxis: settings.showXAxis,
                showYAxis: settings.showYAxis,
                xAxisLabel: settings.xAxisLabel,
                yAxisLabel: settings.yAxisLabel
            };

            const fullState = {
                expressions: expressions,
                config: config
            };
            const stateJson = JSON.stringify(fullState);

            // 2. Capture Screenshot for Editor Preview (Static Image)
            const snapshot = calculator.screenshot({
                width: 600, 
                height: 400, 
                targetPixelRatio: 2
            });

            // 3. Update Existing or Create New
            if (editingDesmosElement) {
                editingDesmosElement.dataset.state = stateJson;
                const img = editingDesmosElement.querySelector('img');
                if(img) img.src = snapshot;
                closeDesmosModal();
                return;
            }

            restoreSelection();

            // Create Wrapper with Image
            const wrapper = document.createElement('div');
            wrapper.className = 'visual-block-wrapper desmos-wrapper';
            wrapper.contentEditable = "false";
            wrapper.dataset.state = stateJson;

            const img = document.createElement('img');
            img.src = snapshot;
            img.style.width = '100%';
            img.style.borderRadius = '8px';

            wrapper.appendChild(img);
            insertNodeAtCursor(wrapper);
            const p = document.createElement('p'); p.innerHTML = "<br>"; wrapper.after(p);

            closeDesmosModal();
        }

        // --- IMAGE MODAL (Called from menu) ---
        function openImageModal() {
            saveSelection(); 
            imgModal.classList.add('active');
            imgUrlInput.focus();
            checkImgInput();
        }
        function closeImageModal() {
            imgModal.classList.remove('active');
            imgUrlInput.value = "";
            imgFileInput.value = "";
            document.getElementById('fileNameDisplay').innerText = "Click to upload from device";
            checkImgInput();
        }
        function handleFileSelect() {
            if(imgFileInput.files.length > 0) document.getElementById('fileNameDisplay').innerText = imgFileInput.files[0].name;
            checkImgInput();
        }
        function checkImgInput() {
            const hasUrl = imgUrlInput.value.trim().length > 0;
            const hasFile = imgFileInput.files.length > 0;
            btnInsertImg.classList.toggle('active', hasUrl || hasFile);
        }
        function confirmInsertImage() {
            restoreSelection();
            if (imgFileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = (e) => insertImageTag(e.target.result);
                reader.readAsDataURL(imgFileInput.files[0]);
            } else if (imgUrlInput.value.trim()) {
                insertImageTag(imgUrlInput.value.trim());
            }
            closeImageModal();
        }
        function insertImageTag(src) {
            const img = document.createElement('img');
            img.src = src;
            insertNodeAtCursor(img);
            const br = document.createElement('br');
            img.after(br);
            const range = document.createRange();
            range.setStartAfter(br);
            range.collapse(true);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        // --- Interaction Logic (Double Click & Delete) ---
        editor.addEventListener('dblclick', (e) => {
            let target = e.target;
            while(target && target !== editor) {
                if(target.classList.contains('mermaid-wrapper')) {
                    editingChartElement = target;
                    openFlowchartModal(JSON.parse(target.dataset.state));
                    return;
                }
                if(target.classList.contains('chart-wrapper')) {
                    editingCjsElement = target;
                    openChartJsModal(JSON.parse(target.dataset.state));
                    return;
                }
                if(target.classList.contains('desmos-wrapper')) {
                    editingDesmosElement = target;
                    openDesmosModal(JSON.parse(target.dataset.state));
                    return;
                }
                target = target.parentElement;
            }
        });

        // --- UPDATED BACKSPACE LOGIC ---
        editor.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace') {
                const sel = window.getSelection();
                if (!sel.rangeCount || !sel.isCollapsed) return;
                
                const anchor = sel.anchorNode;
                const offset = sel.anchorOffset;

                // 1. Check for Block Deletion (Images, Diagrams)
                let block = anchor;
                while (block && block.parentElement && block.parentElement !== editor) { 
                    block = block.parentElement; 
                }
                if (block && sel.anchorOffset === 0) {
                    const prev = block.previousElementSibling;
                    if (prev && (prev.classList.contains('markscheme') || prev.classList.contains('block-container') || prev.classList.contains('visual-block-wrapper') || prev.tagName === 'IMG')) {
                        e.preventDefault();
                        prev.remove();
                        return;
                    }
                }

                // 2. Check for Inline Math Deletion (Finicky Fix)
                if (anchor.nodeType === Node.TEXT_NODE) {
                    // Case A: Cursor is immediately after the math wrapper
                    if (offset === 0) {
                        const prevSibling = anchor.previousSibling;
                        if (prevSibling && prevSibling.classList && prevSibling.classList.contains('math-wrapper')) {
                            e.preventDefault();
                            prevSibling.remove();
                        }
                    } 
                    // Case B: Cursor is after the ZWSP sentinel we inserted
                    else if (offset === 1 && anchor.textContent === '\u200B') {
                        const prevSibling = anchor.previousSibling;
                        if (prevSibling && prevSibling.classList && prevSibling.classList.contains('math-wrapper')) {
                            e.preventDefault();
                            // Delete the Math
                            prevSibling.remove();
                            // Also delete the sentinel text node to keep things clean
                            anchor.remove();
                        }
                    }
                }
            }
        });

        function insertMarkscheme() {
            const details = document.createElement('details');
            details.className = 'markscheme'; details.open = true; details.contentEditable = "false";
            details.innerHTML = `<summary><span class="summary-title" contenteditable="true">Markscheme</span></summary><div class="markscheme-content" contenteditable="true"><p>Answer...</p></div>`;
            insertNodeAtCursor(details); const p = document.createElement('p'); p.innerHTML = "<br>"; details.after(p);
            setTimeout(() => details.querySelector('.summary-title').focus(), 10);
        }

        function downloadMarkdown() {
            let title = docTitle.value.trim();
            if (!title) title = "Untitled Note";
            const filename = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.md';
            const markdown = parseToMarkdown(editor);
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
        }

        function parseToMarkdown(element) {
            let md = "";
            element.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                    let text = node.textContent.replace(/\u200B/g, '').replace(/([\\*_{}[\]()#+\-.!])/g, '\\$1');
                    md += text;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const tag = node.tagName.toLowerCase();
                    const style = window.getComputedStyle(node);
                    let prefix = "", suffix = "";
                    if (tag === 'b' || tag === 'strong' || parseInt(style.fontWeight) > 600) { prefix += "<b>"; suffix = "</b>" + suffix; }
                    if (tag === 'i' || tag === 'em' || style.fontStyle === 'italic') { prefix += "<i>"; suffix = "</i>" + suffix; }
                    if (tag === 'u' || style.textDecorationLine.includes('underline')) { prefix += "<u>"; suffix = "</u>" + suffix; }

                    if (tag === 'h1') md += `\n# ${node.textContent}\n`;
                    else if (tag === 'h2') md += `\n## ${node.textContent}\n`;
                    else if (tag === 'h3') md += `\n### ${node.textContent}\n`;
                    else if (tag === 'img') {
                        // Regular images
                        if (!node.closest('.visual-block-wrapper')) {
                             md += `\n![Image](${node.src})\n`;
                        }
                    }
                    
                    // Export Mermaid
                    else if (node.classList.contains('mermaid-wrapper')) {
                        md += `\n\`\`\`mermaid\n${node.dataset.source}\n\`\`\`\n`;
                    }
                    // Export Chart.js
                    else if (node.classList.contains('chart-wrapper')) {
                        md += `\n\`\`\`chart\n${node.dataset.export}\n\`\`\`\n`;
                    }
                    // Export Desmos
                    else if (node.classList.contains('desmos-wrapper')) {
                        const state = JSON.parse(node.dataset.state);
                        const configStr = JSON.stringify(state.config, null, 2);
                        const exprsStr = state.expressions.join('\n');
                        md += `\n\`\`\`desmos\n//config: ${configStr}\n${exprsStr}\n\`\`\`\n`;
                    }
                    
                    else if (tag === 'math-field') {
                        const latex = node.value;
                        const isChem = node.classList.contains('chem-field');
                        const isBlock = node.parentElement.classList.contains('block-container');
                        const content = isChem ? `\\ce{${latex}}` : latex;
                        md += isBlock ? `\n$$\n${content}\n$$\n` : `$${content}$`;
                    }
                    else if (node.classList.contains('math-wrapper')) md += parseToMarkdown(node);
                    else if (tag === 'details') {
                        const title = node.querySelector('.summary-title').innerText || 'Markscheme';
                        const content = parseToMarkdown(node.querySelector('.markscheme-content'));
                        md += `\n<details>\n<summary>${title}</summary>\n\n${content}\n</details>\n`;
                    }
                    else if (tag === 'p' || tag === 'div') {
                        if (node.classList.contains('block-container')) md += parseToMarkdown(node);
                        else md += `\n${parseToMarkdown(node)}\n`;
                    }
                    else if (tag === 'br') md += "\n";
                    else md += prefix + parseToMarkdown(node) + suffix;
                }
            });
            return md;
        }
    </script>
</body>
</html>
